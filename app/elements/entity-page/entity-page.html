<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/aggregation-query-and-display/aggregation-query-and-display.html">
<link rel="import" href="../../bower_components/array-behavior/array-behavior.html">
<link rel="import" href="../../bower_components/build-and-run-query/build-and-run-query.html">
<link rel="import" href="../../bower_components/dig-logger/dig-logger.html">
<link rel="import" href="../../bower_components/elastic-client/elastic-client.html">
<link rel="import" href="../../bower_components/elastic-client-aggregation-builder/elastic-client-aggregation-builder.html">
<link rel="import" href="../../bower_components/elastic-error/elastic-error.html">
<link rel="import" href="../../bower_components/export-button/export-button.html">
<link rel="import" href="../../bower_components/image-query-and-display/image-query-and-display.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/json-combine/json-combine.html">
<link rel="import" href="../../bower_components/loading-spinner/loading-spinner.html">
<link rel="import" href="../../bower_components/lodash-import/lodash.html">
<link rel="import" href="../../bower_components/log-creator/log-creator.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/profile-manager/profile-manager.html">
<link rel="import" href="../../bower_components/result-list/result-list.html">
<link rel="import" href="../../bower_components/save-case-dialog/save-case-dialog.html">
<link rel="import" href="../../bower_components/selected-facets-display/selected-facets-display.html">
<link rel="import" href="../../bower_components/state-manager/state-manager.html">
<link rel="import" href="../../bower_components/tag-manager/tag-manager.html">
<link rel="import" href="../../bower_components/terms-transformer/terms-transformer.html">
<link rel="import" href="../../bower_components/user-settings-dialog/user-settings-dialog.html">
<link rel="import" href="../../bower_components/zoomable-bar-chart/zoomable-bar-chart.html">
<link rel="import" href="../../elements/copy-button/copy-button.html">
<link rel="import" href="../../elements/info-aggregations/info-aggregations.html">
<link rel="import" href="../../elements/info-data/info-data.html">
<link rel="import" href="../../elements/section-wrapper/section-wrapper.html">
<link rel="import" href="../../elements/transform-functions/transform-functions.html">
<link rel="import" href="../../styles/entity-page-styles.html">
<link rel="import" href="../../styles/icon-styles.html">
<link rel="import" href="../../styles/page-styles.html">

<dom-module id="entity-page">
  <template>
    <style include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning"></style>
    <style include="page-styles"></style>
    <style include="entity-page-styles"></style>
    <style include="icon-styles"></style>

    <style>
      :host {
        display: block;
        @apply --layout-fullbleed;
      }

      .date-menu {
        margin-bottom: 10px;
      }

      .date-menu > div {
        color: var(--secondary-text-color);
        line-height: 24px;
        margin-bottom: 2px;
        margin-right: 10px;
      }

      .date-menu paper-dropdown-menu {
        --paper-input-container: {
          padding: 0 !important;
        };
      }

      .date-menu paper-listbox {
        --paper-listbox: {
          padding: 0;
        };
      }

      .date-menu paper-item {
        --paper-item-min-height: 30px;
        --paper-item: {
          cursor: pointer;
          padding: 0 10px;
          white-space: nowrap;
        };
      }

      aggregation-query-and-display,
      image-query-and-display {
        margin-bottom: 10px;
      }

      image-query-and-display {
        --image-query-and-display-max-height: none;
      }

      selected-facets-display {
        --selected-facet-icon-hover-color: #fff;
      }
    </style>

    <iron-ajax
      auto
      handle-as="json"
      url="/config"
      last-response="{{serverConfig}}">
    </iron-ajax>

    <template is="dom-if" if="[[serverConfig.overrideConfig]]">
      <transform-functions
        client-config="[[serverConfig.overrideConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[serverConfig.overrideConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <template is="dom-if" if="[[!serverConfig.overrideConfig]]">
      <iron-ajax
        auto="[[exists(configHeader)]]"
        handle-as="json"
        headers="[[configHeader]]"
        url="[[concat(serverConfig.configEndpoint, domain)]]"
        with-credentials
        loading="{{clientConfigLoading}}"
        last-error="{{clientConfigError}}"
        last-response="{{clientConfig}}">
      </iron-ajax>

      <transform-functions
        client-config="[[clientConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[clientConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <json-combine
      data-in1="[[clientConfigFields]]"
      data-in2="{}"
      data-out="{{searchFields}}"
      combine-function="[[transforms.config.searchFields]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsCollection}}"
      combine-function="[[transforms.config.searchFieldsCollection]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{aggregationFields}}"
      combine-function="[[transforms.config.aggregationFields]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{dateFieldsToProperties}}"
      combine-function="[[transforms.config.dateFieldsToProperties]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{filterCollection}}"
      combine-function="[[transforms.config.filterCollection]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{filtersBuilderConfig}}"
      combine-function="[[transforms.config.filtersBuilderConfig]]">
    </json-combine>

    <json-combine
      data-in1="[[parameters.id]]"
      data-in2="[[parameters.type]]"
      data-out="{{pageId}}"
      combine-function="[[transforms.config.formatId]]">
    </json-combine>

    <json-combine
      data-in1="[[pageId]]"
      data-in2="[[parameters.type]]"
      data-out="{{pageName}}"
      combine-function="[[transforms.config.formatName]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="[[parameters.type]]"
      data-out="{{pageConfig}}"
      combine-function="[[transforms.config.pageConfig]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{sortField}}"
      combine-function="[[transforms.config.sortField]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{entityFilters}}"
      combine-function="[[transforms.config.entityFilters]]">
    </json-combine>

    <elastic-client
      config="[[serverConfig.esHost]]"
      client="{{esClient}}">
    </elastic-client>

     <!-- Logger for Filter Terms -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Entity-Filter"
      data="[[logMessage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

     <!-- Logger for Pagination -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Entity-ResultPage"
      data="[[searchPage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Page View -->
    <dig-logger log-page-view
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Entity-Open"
      data="[[parameters.state]]"
      username="[[serverConfig.username]]"
      logger="{{logger}}">
    </dig-logger>

    <log-creator
      object="{{filterCollection}}"
      log-message="{{logMessage}}">
    </log-creator>

    <profile-manager
      build-state-data-function="[[transforms.config.searchState]]"
      client="[[esClient]]"
      function-config="[[searchFields]]"
      index-name="[[serverConfig.profileIndexName]]"
      index-type="[[serverConfig.profileIndexType]]"
      query-builder-config="[[searchFields]]"
      query-builder-date-fields="[[dateFieldsToProperties]]"
      username="[[serverConfig.username]]"
      blur-images="{{blurImages}}"
      cases="{{cases}}"
      email-address="{{emailAddress}}"
      notifications="{{notifications}}"
      notification-interval="{{notificationInterval}}"
      profile-manager="{{profileManager}}"
      user-id="{{userId}}"
      user-loading="{{userLoading}}">
    </profile-manager>

    <build-and-run-query
      fields="[[pageConfig.field]]"
      values="[[pageId]]"
      client="[[esClient]]"
      index-name="[[esConfig.esIndex]]"
      index-types="[[esConfig.esType]]"
      aggregations="[]"
      filters="[[filterList]]"
      page="{{searchPage}}"
      page-size="10"
      properties-ready="{{processRequest}}"
      sort-field="[[sortField]]"
      source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "timestamp_crawl", "tld", "url"]'
      transform-config="[[searchFields]]"
      transform-function="[[transforms.entity.documents]]"
      error="{{searchError}}"
      loading="{{searchLoading}}"
      results="{{documents}}"
      total="{{searchTotal}}">
    </build-and-run-query>

    <filters-builder
      callback="[[filtersBuilderCallback]]"
      config="[[filtersBuilderConfig]]"
      data="[[filterCollection]]"
      filters="{{filterList}}">
    </filters-builder>

    <tag-manager
      id="tagManager"
      auth-username="[[serverConfig.configUsername]]"
      auth-password="[[serverConfig.configPassword]]"
      entity-endpoint="[[serverConfig.tagsEntityEndpoint]]"
      extraction-endpoint="[[serverConfig.tagsExtractionEndpoint]]"
      list-endpoint="[[serverConfig.tagsListEndpoint]]"
      project="[[domain]]"
      tag-manager="{{tagManager}}">
    </tag-manager>

    <!-- Must wait for the filterCollection to be defined. -->
    <template is="dom-if" if="[[filterCollection]]">
      <state-manager id="stateManager"
        build-popup-data-function="[[transforms.config.filterTerms]]"
        build-state-data-function="[[transforms.config.filterState]]"
        client="[[esClient]]"
        function-config="[[searchFields]]"
        header-type="Filter"
        state-index="[[serverConfig.stateIndexName]]"
        state-type="[[serverConfig.stateIndexType]]"
        state-id="[[parameters.state]]"
        collection="{{filterCollection}}"
        process-request="{{processRequest}}"
        state-history="{{stateHistory}}"
        has-history="{{hasHistory}}">
      </state-manager>
    </template>

    <save-case-dialog
      id="saveDialog"
      cases="[[cases]]"
      entity-id="[[parameters.id]]"
      entity-name="[[pageName]]"
      entity-type="[[parameters.type]]"
      profile-manager="[[profileManager]]"
      user-id="[[userId]]">
    </save-case-dialog>

    <info-data
      id="dataInfoDialog"
      client="[[esClient]]"
      index-name="[[esConfig.esIndex]]"
      index-types="[[esConfig.esType]]"
      domain="[[domain]]"
      sort-field="timestamp_crawl">
    </info-data>

    <template is="dom-if" if="[[!pageConfig]]">
      <div class="layout horizontal center-justified flex">
        <loading-spinner show type="Page"></loading-spinner>
      </div>
    </template>

    <template is="dom-if" if="[[pageConfig]]">
      <div class="page-head">
        <a id="logoLink" href="/" target="_blank" title="Open a DIG Search Page in a New Tab">
          <img id="logo" src="/images/dig-logo.png" alt="">
        </a>

        <iron-icon class$="page-icon [[pageConfig.styleClass]]" icon="[[pageConfig.icon]]"></iron-icon>

        <div class="page-name">
          <div>[[pageConfig.title]]:</div>

          <template is="dom-if" if="[[!pageConfig.isImage]]">
            <div>[[pageName]]</div>
          </template>

          <template is="dom-if" if="[[pageConfig.isImage]]">
            <json-combine
              data-in1="[[pageId]]"
              data-in2="[[esConfig]]"
              data-out="{{imageSrc}}"
              combine-function="[[transforms.config.imageSrc]]">
            </json-combine>

            <a href="[[imageSrc]]" target="_blank" title="Open Image">
              <iron-image class$="page-image small-blur [[getNoBlurStyleClass(blurImages)]]" src="[[imageSrc]]"></iron-image>
            </a>
          </template>
        </div>

        <user-settings-dialog
          build-popup-data-function="[[transforms.config.searchTerms]]"
          build-state-data-function="[[transforms.config.searchState]]"
          document-icon="av:web"
          document-link-function="[[transforms.config.documentLinkFunction]]"
          document-type-plural="Webpages"
          document-type-singular="Webpage"
          entity-config="[[searchFieldsCollection]]"
          function-config="[[searchFields]]"
          reset-dates-data-function="[[createResetDatesFunction(searchFields)]]"
          user-id="[[userId]]"
          user-loading="[[userLoading]]"
          username="[[serverConfig.username]]"
          blur-images="{{blurImages}}"
          cases="{{cases}}"
          email-address="{{emailAddress}}"
          notifications="{{notifications}}"
          notification-date="{{notificationDate}}"
          notification-interval="{{notificationInterval}}"
          process-request="{{processRequest}}">
        </user-settings-dialog>

        <paper-icon-button id="menuButton" icon="fa:bars" slot="dropdown-trigger" title="More Options" on-tap="toggleMenu"></paper-icon-button>

        <iron-dropdown id="menuDropdown" horizontal-align="right" vertical-align="top" vertical-offset="50">
          <div slot="dropdown-content">
            <paper-icon-item title="Save This [[pageConfig.title]] to Case..." on-tap="openSaveDialog">
              <iron-icon slot="item-icon" icon="fa:floppy-o" item-icon></iron-icon>
              Save This [[pageConfig.title]] to Case...
            </paper-icon-item>

            <paper-icon-item disabled="[[!hasHistory]]" title="View This Page's Filter History" on-tap="openStateHistoryDialog">
              <iron-icon slot="item-icon" icon="fa:history" item-icon></iron-icon>
              View This Page's Filter History
            </paper-icon-item>

            <paper-icon-item title="View DIG Database Information" on-tap="openDataInfoDialog">
              <iron-icon slot="item-icon" icon="fa:database" item-icon></iron-icon>
              View DIG Database Information
            </paper-icon-item>

            <template is="dom-if" if="[[serverConfig.tagsListEndpoint]]">
              <paper-icon-item title="View DIG Data Training Options" on-tap="openTagsDialog">
                <iron-icon slot="item-icon" icon="fa:check-circle" item-icon></iron-icon>
                View DIG Data Training Options
              </paper-icon-item>
            </template>

            <paper-icon-item title="Open a DIG Search Page in a New Tab" on-tap="openNewTab">
              <iron-icon slot="item-icon" icon="fa:external-link-square" item-icon></iron-icon>
              Open a DIG Search Page in a New Tab
            </paper-icon-item>

            <paper-icon-item title="Open DIG Help Page" on-tap="openHelpPage">
              <iron-icon slot="item-icon" icon="fa:question-circle" item-icon></iron-icon>
              Open the DIG Help Page
            </paper-icon-item>

            <paper-icon-item title="Contact DIG / Memex Support (support@memex.software)" on-tap="emailSupport">
              <iron-icon slot="item-icon" icon="fa:envelope" item-icon></iron-icon>
              Contact DIG / Memex Support
            </paper-icon-item>
          </div>
        </iron-dropdown>
      </div>

      <div class="page-body">
        <div class="page-column">
          <template is="dom-repeat" items="[[aggregationFields]]">
            <json-combine
              data-in1="[[item.aggregatedDataResults.length]]"
              data-in2="[[createSectionTitleConfig(pageConfig, item.entity, item.aggregatedDataError, item.aggregatedDataLoading, item.aggregatedSubset)]]"
              data-out="{{item.sectionTitle}}"
              combine-function="[[createSectionTitle]]">
            </json-combine>

            <section-wrapper
              error="[[item.aggregatedDataError]]"
              icon="[[item.entity.icon]]"
              loading="[[item.aggregatedDataLoading]]"
              no-data="[[!item.aggregatedDataResults.length]]"
              section-title="[[item.sectionTitle]]"
              style-class="[[item.entity.styleClass]]"
              on-opened-changed="runSectionAggregationQueries">

              <template is="dom-if" if="[[item.opened]]">
                <elastic-client-aggregation-builder
                  name="[[item.entity.key]]"
                  type="terms"
                  count="0"
                  order="_term"
                  direction="asc"
                  field="[[item.entity.field]]"
                  ejs-aggregation="{{item.entityAggregation}}">
                </elastic-client-aggregation-builder>

                <template is="dom-if" if="[[item.entityAggregation]]">
                  <elastic-client-aggregation-builder
                    name="[[getDateProperty(item.dateCollection, item.dateSelected, 'key')]]"
                    type="date_histogram"
                    count="0"
                    field="[[getDateProperty(item.dateCollection, item.dateSelected, 'field')]]"
                    interval="week"
                    nested-aggregations="[[buildArray(item.entityAggregation)]]"
                    ejs-aggregation="{{item.dateAggregation}}">
                  </elastic-client-aggregation-builder>

                  <template is="dom-if" if="[[item.dateAggregation]]">
                    <build-and-run-query
                      type="terms"
                      fields="[[pageConfig.field]]"
                      values="[[pageId]]"
                      client="[[esClient]]"
                      index-name="[[esConfig.esIndex]]"
                      index-types="[[esConfig.esType]]"
                      aggregations="[[buildArray(item.dateAggregation)]]"
                      filters="[[filterList]]"
                      page-size="0"
                      properties-ready="{{processRequest}}"
                      source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "timestamp_crawl", "tld", "url"]'
                      transform-config="[[createTimelineConfig(item.dateCollection, item.dateSelected, item.entity, pageConfig, pageId)]]"
                      transform-function="[[transforms.entity.histograms]]"
                      error="{{item.timelineDataError}}"
                      loading="{{item.timelineDataLoading}}"
                      results="{{item.timelineDataResults}}">
                    </build-and-run-query>
                  </template>
                </template>
              </template>

              <template is="dom-if" if="[[item.entity.isLocation]]">
                <template is="dom-if" if="[[isMapVisible(item.aggregatedDataLoading, item.aggregatedDataResults, item.opened)]]">
                  <leaflet-wrapper
                    cluster-markers
                    restamp
                    text-property="textAndCount"
                    data="[[item.aggregatedDataResults]]">
                  </leaflet-wrapper>
                </template>
              </template>

              <template is="dom-if" if="[[!item.entity.isImage]]">
                <aggregation-query-and-display
                  hide-bar-chart="[[!item.opened]]"
                  aggregation-name="[[item.entity.key]]"
                  aggregation-field="[[item.entity.field]]"
                  selected-property="[[item.entity.key]]"
                  selected="{{filterCollection}}"
                  query-field="[[pageConfig.field]]"
                  query-value="[[pageId]]"
                  client="[[esClient]]"
                  index-name="[[esConfig.esIndex]]"
                  index-types="[[esConfig.esType]]"
                  filter-list="[[filterList]]"
                  properties-ready="[[processRequest]]"
                  transform-config="[[createExtractionConfig(item.entity, pageConfig, pageId)]]"
                  transform-function="[[transforms.entity.extractions]]"
                  data="{{item.aggregatedDataResults}}"
                  error-message="{{item.aggregatedDataError}}"
                  header-data-name="[[item.entity.titlePlural]]"
                  header-counts-name="Webpages"
                  header-entity-name="[[pageName]]"
                  limit="0"
                  loading="{{item.aggregatedDataLoading}}"
                  show-checkboxes
                  show-double-bar-chart="[[showDoubleBarChart(item.entity)]]">
                </aggregation-query-and-display>
              </template>

              <template is="dom-if" if="[[item.entity.isImage]]">
                <image-query-and-display
                  hide-images="[[!item.opened]]"
                  aggregation-field="[[item.entity.field]]"
                  aggregation-name="[[item.entity.key]]"
                  client="[[esClient]]"
                  filter-list="[[filterList]]"
                  header-data-name="[[item.entity.titlePlural]]"
                  header-counts-name="Webpages"
                  header-entity-name="[[pageName]]"
                  index-name="[[esConfig.esIndex]]"
                  index-types="[[esConfig.esType]]"
                  properties-ready="[[processRequest]]"
                  query-fields="[[pageConfig.field]]"
                  query-values="[[pageId]]"
                  transform-config="[[createExtractionConfig(item.entity, pageConfig, pageId)]]"
                  transform-function="[[transforms.entity.extractions]]"
                  small-image-style-class="[[getBlurStyleClass(blurImages)]]"
                  large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]"
                  error-message="{{item.aggregatedDataError}}"
                  images="{{item.aggregatedDataResults}}"
                  limit="0"
                  loaded-images="{{item.aggregatedSubset}}"
                  loading="{{item.aggregatedDataLoading}}"
                  selected-property="[[item.entity.key]]"
                  selected="{{filterCollection}}"
                  show-checkboxes>
                </image-query-and-display>
              </template>

              <template is="dom-if" if="[[item.aggregatedDataResults.length]]">
                <terms-transformer
                  category="[[item.entity.title]]"
                  object="{{entityFilters}}"
                  object-property="[[item.entity.key]]"
                  list="[[getFacetsList(filterCollection, item.entity.key, filterCollection.*)]]"
                  text-function="[[getTextFunction(item.aggregatedDataResults)]]">
                </terms-transformer>

                <div class="layout horizontal center" style="margin: 20px 0;">
                  <copy-button class="flex" data="[[item.aggregatedDataResults]]" name="[[item.entity.titlePlural]]" text-function="[[createCopyTextFunction(item.entity.isLocation)]]"></copy-button>

                  <template is="dom-if" if="[[showDoubleBarChart(item.entity)]]">
                    <info-aggregations entity="[[pageName]]" type="[[item.entity.title]]"></info-aggregations>
                  </template>
                </div>
              </template>

              <template is="dom-if" if="[[item.timelineDataLoading]]">
                <div>Loading Timelines...</div>
              </template>

              <template is="dom-if" if="[[!item.timelineDataLoading]]">
                <template is="dom-if" if="[[item.showDateMenu]]">
                  <div class="layout horizontal center date-menu">
                    <div>Date Field</div>

                    <paper-dropdown-menu label="Date" no-label-float>
                      <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{item.dateSelected}}">
                        <template is="dom-repeat" items="[[item.dateList]]" as="dateListItem">
                          <paper-item id$="[[dateListItem.key]]" value="[[dateListItem.key]]">[[dateListItem.title]]</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                  </div>
                </template>

                <template is="dom-if" if="[[item.timelineDataError]]">
                  <elastic-error error="[[item.timelineDataError]]" message="{{item.timelineDataErrorMessage}}"></elastic-error>
                  <div>Timeline [[item.timelineDataErrorMessage]]</div>
                </template>

                <template is="dom-if" if="[[!item.timelineDataError]]">
                  <template is="dom-if" if="[[!item.timelineDataResults.items.length]]">
                    <div>No Timelines of [[item.entity.title]] vs. [[getDateProperty(item.dateCollection, item.dateSelected, 'title')]]</div>
                  </template>
                </template>

                <template is="dom-if" if="[[item.timelineDataResults.items.length]]">
                  <sparkline-list hide-sparkline-chart="[[!item.opened]]" data="[[item.timelineDataResults.items]]"></sparkline-list>

                  <div class="layout horizontal center" style="margin: 10px 0;">
                    <button-action icon="timeline" text="[[getBarChartButtonText(item.showBarChart)]]" click-listener="[[createToggleBarChartListener(index)]]"></button-action>
                  </div>

                  <zoomable-bar-chart
                    load="[[item.showBarChart]]"
                    timeline
                    selected-property="[[getDateProperty(item.dateCollection, item.dateSelected, 'key')]]"
                    selected="{{filterCollection}}"
                    bar-property="date"
                    label-property="text"
                    stack-property="data"
                    interval="week"
                    data="[[item.timelineDataResults.dates]]"
                    default-label="Unidentified [[item.entity.titlePlural]]"
                    source="Webpages"
                    loading="[[item.timelineDataLoading]]"
                    display-filter-text>
                  </zoomable-bar-chart>

                  <terms-transformer
                    category="[[getDateProperty(item.dateCollection, item.dateSelected, 'title')]]"
                    object="{{entityFilters}}"
                    object-property="[[getDateProperty(item.dateCollection, item.dateSelected, 'key')]]"
                    list="[[getDateFacetsList(filterCollection, item.dateCollection, item.dateSelected, 'key', filterCollection.*)]]">
                  </terms-transformer>
                </template>
              </template>
            </section-wrapper>
          </template>
        </div>

        <div class="page-column">
          <section-wrapper
            icon="fa:filter"
            section-title="[[createFilterSectionTitle(filterList)]]"
            style-class="grey"
            opened="[[filterList.length]]"
            no-toggle
            no-data="[[!filterList.length]]"
            hide-load-icon>

            <template is="dom-repeat" items="[[searchFields]]">
              <selected-facets-display
                facets="{{entityFilters}}"
                facet-key="[[item.key]]"
                hide-remove-button="[[item.isDate]]">
              </selected-facets-display>
            </template>
          </section-wrapper>

          <section-wrapper
            class="results-section"
            error="[[searchError]]"
            icon="av:web"
            loading="[[searchLoading]]"
            section-title="[[searchTitle]]"
            style-class="grey"
            opened
            no-toggle
            no-data="[[!searchTotal]]"
            hide-load-icon>

            <template is="dom-if" if="[[documentsShown]]">
              <export-button
                slot="title"
                data="[[documentsShown]]"
                search-fields="[[searchFields]]"
                transform-csv-function="[[transforms.export.createExportDataForCsv]]"
                transform-pdf-function="[[transforms.export.createExportDataForPdf]]">
              </export-button>
            </template>

            <template is="dom-if" if="[[searchError]]">
              <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
              <div class="results-error">[[searchErrorMessage]]</div>
            </template>

            <result-list
              text-property="title"
              query-results="[[documents]]"
              total-results="{{searchTotal}}"
              shown-results="{{documentsShown}}"
              page="{{searchPage}}"
              page-size="10"
              loading="[[searchLoading]]"
              pretty-name="Webpage Results"
              pretty-name-singular="Webpage Result"
              header="{{searchTitle}}"
              cache-transform="[[transforms.entity.cache]]"
              client="[[esClient]]"
              index-name="[[esConfig.esIndex]]"
              index-types="[[esConfig.esType]]"
              search-fields="[[searchFields]]"
              source-include='["raw_content"]'
              small-image-style-class="[[getBlurStyleClass(blurImages)]]"
              large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]"
              tag-manager="[[tagManager]]">
            </result-list>
          </section-wrapper>
        </div>
      </div>
    </template>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      /* globals _, DigBehaviors */
      is: 'entity-page',

      behaviors: [
        DigBehaviors.ArrayBehavior
      ],

      properties: {
        aggregationFields: {
          type: Array
        },

        blurImages: {
          type: Boolean
        },

        cases: {
          type: Array
        },

        clientConfig: {
          type: Object
        },

        clientConfigError: {
          type: Object
        },

        clientConfigFields: {
          type: Object
        },

        clientConfigLoading: {
          type: Boolean
        },

        configHeader: {
          computed: 'createAuthHeader(serverConfig)',
          type: Object
        },

        dateFieldsToProperties: {
          type: Object
        },

        documents: {
          type: Array
        },

        documentsShown: {
          type: Array
        },

        domain: {
          computed: 'findDomain(parameters, serverConfig)',
          type: String
        },

        emailAddress: {
          type: String
        },

        entityFilters: {
          type: Object
        },

        esClient: {
          type: Object
        },

        esConfig: {
          type: Object
        },

        filterCollection: {
          type: Object
        },

        filterList: {
          type: Array
        },

        filtersBuilderCallback: {
          type: Object,
          value: function() {
            return {
              dates: function(items) {
                return items;
              },
              terms: function(items) {
                return items;
              }
            };
          }
        },

        filtersBuilderConfig: {
          type: Object
        },

        hasHistory: {
          type: Boolean
        },

        logger: {
          type: Object
        },

        logMessage: {
          type: Object
        },

        notifications: {
          type: Boolean
        },

        notificationInterval: {
          type: String
        },

        pageConfig: {
          type: Object
        },

        pageId: {
          type: String
        },

        pageName: {
          type: String
        },

        parameters: {
          computed: 'findUrlParameters()',
          observer: 'updateProcessRequest',
          type: Object
        },

        processRequest: {
          type: Boolean,
          value: false
        },

        profileManager: {
          type: Object
        },

        searchError: {
          type: Object
        },

        searchErrorMessage: {
          type: String
        },

        searchFields: {
          type: Array
        },

        searchLoading: {
          type: Boolean
        },

        searchPage: {
          type: Number
        },

        searchTitle: {
          type: String
        },

        searchTotal: {
          type: Number
        },

        serverConfig: {
          type: Object
        },

        sortField: {
          type: String
        },

        stateHistory: {
          type: Array
        },

        tagManager: {
          type: Object
        },

        transforms: {
          type: Object
        },

        userId: {
          type: String
        },

        userLoading: {
          type: Boolean
        }
      },

      observers: [
        'handleRemoveFilter(entityFilters.*)'
      ],

      attached: function() {
        var self = this;

        window.onpopstate = function() {
          // TODO: refreshing for now. Need to address issues with interrupting logging entries -- perhaps a better
          // approach would to be not to reload the page, but to rerun the query with the changed parameters + make
          // sure logging is done correctly in this case, which may involve adding processRequest to create-log-message.
          window.location.reload();
        };

        window.onload = function() {
          if(window.history.state && window.history.state.stateHistory) {
            self.set('stateHistory', window.history.state.stateHistory);
          }
        };
      },

      concat: function(a, b) {
        if(a && b) {
          return a + b;
        }
        return undefined;
      },

      createAuthHeader: function(serverConfig) {
        if(serverConfig.configUsername && serverConfig.configPassword) {
          return {
            'Authorization': 'Basic ' + btoa(serverConfig.configUsername + ':' + serverConfig.configPassword)
          };
        }
        return {};
      },

      createResetDatesFunction: function(searchFields) {
        return function(searchParameters, startDateString, endDateString) {
          searchFields.forEach(function(searchFieldsObject) {
            if(searchFieldsObject.isDate) {
              searchParameters[searchFieldsObject.key] = {};
              searchParameters[searchFieldsObject.key][searchFieldsObject.dateProperties.start.key] = startDateString ? {
                key: searchFieldsObject.dateProperties.start.key,
                category: searchFieldsObject.dateProperties.start.title,
                date: new Date(startDateString),
                enabled: true,
                text: startDateString
              } : undefined;
              searchParameters[searchFieldsObject.key][searchFieldsObject.dateProperties.end.key] = endDateString ? {
                key: searchFieldsObject.dateProperties.end.key,
                category: searchFieldsObject.dateProperties.end.title,
                date: new Date(endDateString),
                enabled: true,
                text: endDateString
              } : undefined;
            }
          });
          return searchParameters;
        };
      },

      exists: function(object) {
        return typeof object !== 'undefined';
      },

      findDomain: function(parameters, serverConfig) {
        if(parameters && serverConfig) {
          /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
          var override = serverConfig.overrideConfig ? serverConfig.overrideConfig.project_name : '';
          /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
          return override || parameters.domain || parameters.project || serverConfig.defaultProject;
        }
        return undefined;
      },

      findUrlParameters: function() {
        var parameterInput = window.location.search;
        var parameters = {};
        if(parameterInput && parameterInput !== '?') {
          (parameterInput.indexOf('?') === 0 ? parameterInput.slice(1) : parameterInput).split('&').forEach(function(parameter) {
            var parameterSplit = parameter.split('=');
            parameters[parameterSplit[0]] = (parameterSplit.length > 1 ? parameterSplit[1] : true);
          });
        }
        return parameters;
      },

      getBlurStyleClass: function(blur, large) {
        return (blur ? (large ? 'large-blur' : 'small-blur') : '');
      },

      /************* PAGE *************/
      createCopyTextFunction: function(isLocation) {
        if(!isLocation) {
          return function(item) {
            return item.id;
          };
        }
        return function(item) {
          if(item.textAndCount.indexOf(',') >= 0) {
            return item.textAndCount.substring(0, item.textAndCount.indexOf(','));
          }
          return item.textAndCount;
        };
      },

      createExtractionConfig: function(entityConfig, pageConfig, id) {
        if(!entityConfig || !pageConfig || !id) {
          return undefined;
        }
        return {
          entity: entityConfig,
          page: pageConfig,
          id: id
        };
      },

      createSectionTitle: function(size, config) {
        if(config.loading) {
          return 'Loading' + (config.sayOther ? ' Other ' : ' ') + config.namePlural + '...';
        }
        if(config.error) {
          return (config.sayOther ? 'Other ' : '') + config.namePlural + ' ' + config.error;
        }
        var sizeString = (size || 'No').toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        var totalCountString = config.totalCount !== undefined && config.totalCount > size ? ' of ' + config.totalCount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') : '';
        return sizeString + totalCountString + (config.sayOther ? ' Other ' : ' ') + (size === 1 ? config.name : config.namePlural);
      },

      createSectionTitleConfig: function(pageConfig, searchFieldsObject, error, loading, totalCount) {
        if(!pageConfig || !searchFieldsObject) {
          return undefined;
        }
        return {
          error: error,
          loading: loading,
          name: searchFieldsObject.title,
          namePlural: searchFieldsObject.titlePlural,
          sayOther: (pageConfig.key === searchFieldsObject.key),
          totalCount: totalCount
        };
      },

      createTimelineConfig: function(dateCollection, dateSelected, entityConfig, pageConfig, id) {
        if(!dateCollection || !dateSelected || !entityConfig || !pageConfig || !id) {
          return undefined;
        }
        return {
          date: dateCollection[dateSelected],
          entity: entityConfig,
          page: pageConfig,
          id: id
        };
      },

      createToggleBarChartListener: function(index) {
        var self = this;
        return {
          onClick: function() {
            self.set(['aggregationFields', index, 'showBarChart'], !self.aggregationFields[index].showBarChart);
          }
        };
      },

      equals: function(one, two) {
        return one === two;
      },

      getBarChartButtonText: function(shown) {
        return (shown ? 'Hide' : 'Show') + ' Detailed Timeline';
      },

      getDateProperty: function(collection, selected, property) {
        if(!collection || !selected || !property) {
          return undefined;
        }
        return collection[selected][property];
      },

      getNoBlurStyleClass: function(blur) {
        return (blur ? '' : 'no-blur');
      },

      isMapVisible: function(loading, data, opened) {
        // Ensure the map section is opened prior to rendering.
        return !loading && !!(data && data.length) && opened;
      },

      runSectionAggregationQueries: function(event) {
        if(event.detail.value) {
          event.model.set('item.opened', true);
        }
      },

      showDoubleBarChart: function(searchFieldsConfig) {
        return searchFieldsConfig.link === 'entity';
      },

      updateProcessRequest: function(parameters) {
        if(!parameters.state) {
          this.set('processRequest', true);
        }
      },
      /********************************/

      /************ FILTER ************/
      createFilterSectionTitle: function(filterList) {
        return (filterList.length || 'No') + ' Filter' + (filterList.length === 1 ? '' : 's');
      },

      doesHaveFilters: function(entityFilters) {
        var answer = false;
        _.keys(entityFilters).forEach(function(type) {
          _.keys(entityFilters[type]).forEach(function(term) {
            if(entityFilters[type][term].enabled) {
              answer = true;
            }
          });
        });
        return answer;
      },

      getDateFacetsList: function(facetsCollection, dateCollection, dateSelected, keyProperty) {
        if(!dateCollection || !dateSelected || !keyProperty) {
          return undefined;
        }
        var key = dateCollection[dateSelected][keyProperty];
        if(facetsCollection[key].length === 2) {
          return [this.transforms.config.formatDate(facetsCollection[key][0]) + ' to ' + this.transforms.config.formatDate(facetsCollection[key][1])];
        }
        return [];
      },

      getFacetsList: function(collection, key) {
        return collection[key];
      },

      getTextFunction: function(data) {
        return function(id) {
          var text = '';

          if(data) {
            data.forEach(function(object) {
              if(id === object.id) {
                text = object.text;
                return;
              }
            });
          }
          return text;
        };
      },

      /**
       * Handles removing a filter using the selected-facets-display.
       */
      handleRemoveFilter: function() {
        var self = this;
        _.keys(this.entityFilters).forEach(function(type) {
          _.keys(self.entityFilters[type]).forEach(function(term) {
            if(!self.entityFilters[type][term].enabled && self.filterCollection[type] && self.filterCollection[type].indexOf(term) >= 0) {
              self.set(['filterCollection', type], self.filterCollection[type].map(function(id) {
                return id;
              }).filter(function(id) {
                return id !== self.entityFilters[type][term].key;
              }));
            }
          });
        });
      },
      /********************************/

      /************* MENU *************/
      emailSupport: function() {
        window.open('mailto:support@memex.software');
      },

      openDataInfoDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#dataInfoDialog').open();
      },

      openHelpPage: function() {
        this.$$('#menuDropdown').close();
        window.open('./help.html');
      },

      openNewTab: function() {
        window.open('./?project=' + this.domain);
      },

      openSaveDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#saveDialog').open();
      },

      openStateHistoryDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#stateManager').openStateHistory();
      },

      openTagsDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#tagManager').openDialog();
      },

      toggleMenu: function() {
        if(this.$$('#menuDropdown').style.display === 'none') {
          this.$$('#menuDropdown').open();
        } else {
          this.$$('#menuDropdown').close();
        }
      }
      /********************************/
    });
  })();
  </script>
</dom-module>
