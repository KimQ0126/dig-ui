<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/array-behavior/array-behavior.html">
<link rel="import" href="../../bower_components/dig-logger/dig-logger.html">
<link rel="import" href="../../bower_components/elastic-client/elastic-client.html">
<link rel="import" href="../../bower_components/elastic-error/elastic-error.html">
<link rel="import" href="../../bower_components/export-button/export-button.html">
<link rel="import" href="../../bower_components/facet-panel/facet-panel.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/json-combine/json-combine.html">
<link rel="import" href="../../bower_components/loading-spinner/loading-spinner.html">
<link rel="import" href="../../bower_components/lodash-import/lodash.html">
<link rel="import" href="../../bower_components/log-creator/log-creator.html">
<link rel="import" href="../../bower_components/nested-list/nested-list.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/profile-manager/profile-manager.html">
<link rel="import" href="../../bower_components/query-builder/query-builder.html">
<link rel="import" href="../../bower_components/query-transformer/query-transformer.html">
<link rel="import" href="../../bower_components/result-list/result-list.html">
<link rel="import" href="../../bower_components/save-case-dialog/save-case-dialog.html">
<link rel="import" href="../../bower_components/search-fields-dialog/search-fields-dialog.html">
<link rel="import" href="../../bower_components/state-manager/state-manager.html">
<link rel="import" href="../../bower_components/tag-manager/tag-manager.html">
<link rel="import" href="../../bower_components/user-settings-dialog/user-settings-dialog.html">
<link rel="import" href="../../elements/info-data/info-data.html">
<link rel="import" href="../../elements/info-facets/info-facets.html">
<link rel="import" href="../../elements/info-search/info-search.html">
<link rel="import" href="../../elements/transform-functions/transform-functions.html">
<link rel="import" href="../../styles/page-styles.html">

<dom-module id="search-page">
  <template>
    <style include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning"></style>
    <style include="page-styles"></style>

    <style>
      :host {
        display: block;
        @apply --layout-fullbleed;
      }

      search-fields-dialog {
        /* Center with the screen.  Left:  320px facets drawer.  Right:  10px navbar padding + 40px per navbar icon. */
        margin-right: 230px;
      }

      #pageDrawer {
        --paper-drawer-panel-left-drawer-container: {
          background-color: var(--primary-background-color);
          border-right: 1px solid rgba(0,0,0,var(--dark-divider-opacity));
        };
      }

      #pageNavbar {
        background-color: var(--navbar-color);
        color: var(--text-primary-color);
        --paper-toolbar-height: 50px;
        --paper-toolbar-content: {
          padding: 0 10px;
        };
      }

      #reloadButton {
        height: 30px;
        width: 30px;
        padding: 0;
      }

      /* Spacer to match drawer width */
      #pageNavbar .drawer-spacer {
        width: 220px;
      }

      #pageFacets {
        --facet-panel-selected-facet-icon-hover-color: #fff;
      }

      #pageSearch {
        --paper-header-panel-container: {
          background-color: #ffffff;
        };
      }

      #searchHeader,
      #searchTimeline {
        padding: 10px;
      }

      #searchHeader .search-results-title {
        font-size: 20px;
        font-weight: 500;
        /* Match the height of the export button. */
        line-height: 30px;
        /* Needed to fix flexbox layout issues in newer browsers. */
        display: -webkit-box;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        word-break: break-word;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
      }

      #searchHeader sparkline-list {
        height: 25px;
        margin-top: 15px;
      }

      #searchResultList {
        --result-list-max-height: none;
      }

      #searchTabs paper-tabs {
        height: 40px;
      }

      #searchTabs paper-tab {
        color: var(--secondary-text-color);
        font-size: 16px;
        font-weight: 500;
        padding: 0 15px;
      }

      #searchTabs paper-tab:hover {
        background-color: rgba(0,0,0,0.05);
        color: var(--primary-text-color);
      }

      #searchTabs paper-tab.iron-selected {
        background-color: rgba(0,0,0,0.1);
        color: var(--primary-text-color);
      }

      #searchTimeline .timeline-text {
        line-height: 20px;
      }

      #searchTimeline .timeline-header {
        margin-bottom: 5px;
      }
    </style>

    <iron-ajax
      auto
      handle-as="json"
      url="/config"
      last-response="{{serverConfig}}">
    </iron-ajax>

    <template is="dom-if" if="[[serverConfig.overrideConfig]]">
      <transform-functions
        client-config="[[serverConfig.overrideConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[serverConfig.overrideConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <template is="dom-if" if="[[!serverConfig.overrideConfig]]">
      <iron-ajax
        auto="[[exists(configHeader)]]"
        handle-as="json"
        headers="[[configHeader]]"
        url="[[concat(serverConfig.configEndpoint, domain)]]"
        with-credentials
        loading="{{clientConfigLoading}}"
        last-error="{{clientConfigError}}"
        last-response="{{clientConfig}}">
      </iron-ajax>

      <transform-functions
        client-config="[[clientConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[clientConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <json-combine
      data-in1="[[clientConfigFields]]"
      data-in2="{}"
      data-out="{{searchFields}}"
      combine-function="[[transforms.config.searchFields]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{dateFieldsToProperties}}"
      combine-function="[[transforms.config.dateFieldsToProperties]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{datePropertiesToKeys}}"
      combine-function="[[transforms.config.datePropertiesToKeys]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsDialogConfig}}"
      combine-function="[[transforms.config.searchFieldsDialogConfig]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsCollection}}"
      combine-function="[[transforms.config.searchFieldsCollection]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchKeys}}"
      combine-function="[[transforms.config.searchKeys]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchParameters}}"
      combine-function="[[transforms.config.searchParameters]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{networkExpansionParameters}}"
      combine-function="[[transforms.config.networkExpansionParameters]]">
    </json-combine>

    <json-combine
      data-in1="[[datePropertiesToKeys]]"
      data-in2="{}"
      data-out="{{searchQuery}}"
      combine-function="[[transforms.search.createSearchQuery]]">
    </json-combine>

    <json-combine
      data-in1="[[datePropertiesToKeys]]"
      data-in2="{}"
      data-out="{{facetsQuery}}"
      combine-function="[[transforms.search.createFacetsQuery]]">
    </json-combine>

    <template is="dom-if" if="[[!serverConfig.sendSearchesDirectlyToES]]">
      <query-transformer
        error="{{searchError}}"
        loading="{{searchLoading}}"
        page="{{searchPage}}"
        page-size="10"
        process-request="[[processRequest]]"
        result-config="[[createSearchResultConfig(networkExpansionParameters, networkExpansionParameters.*)]]"
        result-function="[[transforms.search.searchResults]]"
        results="{{searchQueryTransformerResults}}"
        search-parameters="[[searchParameters]]"
        search-config="[[networkExpansionParameters]]"
        search-function="[[searchQuery]]"
        total-count-function="[[createTotalCountFunction()]]"
        total="{{searchTotal}}"
        url="[[esConfig.searchEndpoint]]">
      </query-transformer>

      <json-combine
        data-in1="[[searchQueryTransformerResults]]"
        data-in2="[[searchFields]]"
        data-out="{{searchResults}}"
        combine-function="[[transforms.entity.results]]">
      </json-combine>
    </template>

    <elastic-client
      config="[[serverConfig.esHost]]"
      client="{{esClient}}">
    </elastic-client>

    <query-builder
      config="[[searchFieldsCollection]]"
      data="[[searchParameters]]"
      date-fields="[[dateFieldsToProperties]]"
      query="{{esQuery}}">
    </query-builder>

    <template is="dom-if" if="[[serverConfig.sendSearchesDirectlyToES]]">
      <query-builder
        config="[[searchFieldsCollection]]"
        data="[[searchParameters]]"
        date-fields="[[dateFieldsToProperties]]"
        query="{{esQuery}}">
      </query-builder>

      <build-and-run-query
        query="[[esQuery]]"
        client="[[esClient]]"
        index-name="[[esConfig.esIndex]]"
        index-types="[[esConfig.esType]]"
        aggregations="[]"
        filters="[]"
        page="{{searchPage}}"
        page-size="10"
        properties-ready="[[processRequest]]"
        source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "@timestamp", "timestamp", "tld", "url"]'
        source-exclude='["knowledge_graph.*.provenance"]'
        transform-config="[[searchFields]]"
        transform-function="[[transforms.entity.results]]"
        error="{{searchError}}"
        loading="{{searchLoading}}"
        results="{{searchResults}}">
      </build-and-run-query>
    </template>

    <!-- Logger for Search Terms -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Search-SubmitSearch"
      data="[[logMessage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Pagination -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Search-ResultPage"
      data="[[searchPage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Page View -->
    <dig-logger log-page-view
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndexName]]"
      es-type="[[serverConfig.logIndexType]]"
      type="Search-Open"
      data="[[parameters.state]]"
      username="[[serverConfig.username]]"
      logger="{{logger}}">
    </dig-logger>

    <log-creator
      object="{{searchParameters}}"
      log-message="{{logMessage}}">
    </log-creator>

    <profile-manager
      build-state-data-function="[[transforms.config.searchState]]"
      client="[[esClient]]"
      function-config="[[searchFields]]"
      index-name="[[serverConfig.profileIndexName]]"
      index-type="[[serverConfig.profileIndexType]]"
      network-expansion-parameters="[[networkExpansionParameters]]"
      query-builder-config="[[searchFieldsCollection]]"
      query-builder-date-fields="[[dateFieldsToProperties]]"
      search-parameters="[[searchParameters]]"
      username="[[serverConfig.username]]"
      blur-images="{{blurImages}}"
      cases="{{cases}}"
      email-address="{{emailAddress}}"
      notifications="{{notifications}}"
      notification-interval="{{notificationInterval}}"
      profile-manager="{{profileManager}}"
      user-id="{{userId}}"
      user-loading="{{userLoading}}">
    </profile-manager>

    <tag-manager
      id="tagManager"
      auth-username="[[serverConfig.configUsername]]"
      auth-password="[[serverConfig.configPassword]]"
      entity-endpoint="[[serverConfig.tagsEntityEndpoint]]"
      extraction-endpoint="[[serverConfig.tagsExtractionEndpoint]]"
      list-endpoint="[[serverConfig.tagsListEndpoint]]"
      project="[[domain]]"
      tag-manager="{{tagManager}}">
    </tag-manager>

    <!-- Must wait for the searchParameters to be defined. -->
    <template is="dom-if" if="[[searchParameters]]">
      <state-manager id="stateManager"
        build-popup-data-function="[[transforms.config.searchTerms]]"
        build-state-data-function="[[transforms.config.searchState]]"
        client="[[esClient]]"
        function-config="[[searchFields]]"
        state-index="[[serverConfig.stateIndexName]]"
        state-type="[[serverConfig.stateIndexType]]"
        state-id="[[parameters.state]]"
        collection="{{searchParameters}}"
        network-expansion="{{networkExpansionParameters}}"
        process-request="{{processRequest}}"
        state-history="{{stateHistory}}"
        has-history="{{hasHistory}}">
      </state-manager>
    </template>

    <save-case-dialog
      id="saveDialog"
      build-popup-data-function="[[transforms.config.searchTerms]]"
      cases="[[cases]]"
      function-config="[[searchFields]]"
      network-expansion-parameters="[[networkExpansionParameters]]"
      profile-manager="[[profileManager]]"
      search-parameters="[[searchParameters]]"
      user-id="[[userId]]">
    </save-case-dialog>

    <info-data
      id="dataInfoDialog"
      client="[[esClient]]"
      index-name="[[esConfig.esIndex]]"
      index-types="[[esConfig.esType]]"
      domain="[[domain]]"
      sort-field="@timestamp">
    </info-data>

    <bulk-search
      id="bulkSearchDialog"
      search-fields="[[searchFields]]"
      parameter-key="[[searchFields.0.key]]"
      search-parameters="{{searchParameters}}"
      process-request="{{processRequest}}"
      build-search-state="[[buildSearchState]]">
    </bulk-search>

    <elastic-client-aggregation-builder
      name="@timestamp"
      type="date_histogram"
      count="0"
      field="@timestamp"
      interval="week"
      ejs-aggregation="{{dateAggregation}}">
    </elastic-client-aggregation-builder>

    <template is="dom-if" if="[[dateAggregation]]">
      <build-and-run-query
        query="[[esQuery]]"
        client="[[esClient]]"
        index-name="[[esConfig.esIndex]]"
        index-types="[[esConfig.esType]]"
        aggregations="[[buildArray(dateAggregation)]]"
        filters="[]"
        page-size="0"
        source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "@timestamp", "timestamp", "tld", "url"]'
        source-exclude='["knowledge_graph.*.provenance"]'
        transform-config='{"date":{"key":"@timestamp"},"entity":{"color":"black"}}'
        transform-function="[[transforms.entity.searchPageTimeline]]"
        error="{{sparklineError}}"
        loading="{{sparklineLoading}}"
        results="{{sparklineResults}}">
      </build-and-run-query>
    </template>

    <iron-ajax
      id="imageSimilaritySearch"
      content-type="application/x-www-form-urlencoded"
      handle-as="json"
      loading="{{imageSimilaritySearchLoading}}"
      method="POST"
      params="{}"
      with-credentials
      on-error="handleImageSimilaritySearchResults"
      on-response="handleImageSimilaritySearchResults">
    </iron-ajax>

    <iron-ajax
      id="imageFaceSearch"
      content-type="application/x-www-form-urlencoded"
      handle-as="json"
      loading="{{imageFaceSearchLoading}}"
      method="POST"
      params="{}"
      with-credentials
      on-error="handleImageFaceSearchResults"
      on-response="handleImageFaceSearchResults">
    </iron-ajax>

    <paper-header-panel class="flex" mode="waterfall">
      <paper-toolbar slot="header" id="pageNavbar">
        <a id="logoLink" slot="top" href="/" target="_blank" title="Open a DIG Search Page in a New Tab">
          <img id="logo" src="/images/dig-logo.png" alt="">
        </a>

        <div slot="top" class="drawer-spacer"></div>

        <div slot="top" class="flex">
          <search-fields-dialog
            date-config="[[datePropertiesToKeys]]"
            hide-images="[[!validateImageServiceConfig(serverConfig.imageServiceConfig)]]"
            image-url-prefix="[[esConfig.imageUrlPrefix]]"
            image-url-suffix="[[esConfig.imageUrlSuffix]]"
            images="{{imagesUploaded}}"
            images-processing="[[imagesProcessing]]"
            large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]"
            search-fields-config="[[searchFieldsDialogConfig]]"
            small-image-style-class="[[getBlurStyleClass(blurImages)]]"
            network-expansion-parameters="{{networkExpansionParameters}}"
            process-request="{{processRequest}}"
            search-parameters="{{searchParameters}}">
          </search-fields-dialog>
        </div>

        <a slot="top" href="[[getUrlWithProject(domain)]]" style="color: #ffffff;">
          <paper-icon-button id="reloadButton" icon="fa:times" title="Reset Page"></paper-icon-button>
        </a>

        <user-settings-dialog
          slot="top"
          enable-search
          build-popup-data-function="[[transforms.config.searchTerms]]"
          build-state-data-function="[[transforms.config.searchState]]"
          entity-config="[[searchFieldsCollection]]"
          function-config="[[searchFields]]"
          reset-dates-data-function="[[createResetDatesFunction(searchFields)]]"
          result-icon="av:web"
          result-link-function="[[transforms.config.resultLinkFunction]]"
          result-type-plural="Webpages"
          result-type-singular="Webpage"
          user-id="[[userId]]"
          user-loading="[[userLoading]]"
          username="[[serverConfig.username]]"
          blur-images="{{blurImages}}"
          cases="{{cases}}"
          email-address="{{emailAddress}}"
          network-expansion-parameters="{{networkExpansionParameters}}"
          notifications="{{notifications}}"
          notification-date="{{notificationDate}}"
          notification-interval="{{notificationInterval}}"
          process-request="{{processRequest}}"
          search-parameters="{{searchParameters}}">
        </user-settings-dialog>

        <paper-icon-button id="menuButton" icon="fa:bars" slot="top" slot="dropdown-trigger" title="More Options" on-tap="toggleMenu"></paper-icon-button>

        <iron-dropdown id="menuDropdown" slot="top" horizontal-align="right" vertical-align="top" vertical-offset="50">
          <div slot="dropdown-content">
            <paper-icon-item disabled="[[searchParametersDisabled(searchParameters, searchParameters.*)]]" title="Save Search to Case..." on-tap="openSaveDialog">
              <iron-icon slot="item-icon" icon="fa:floppy-o" item-icon></iron-icon>
              Save Search to Case...
            </paper-icon-item>

            <paper-icon-item disabled="[[!hasHistory]]" title="View Your Search History" on-tap="openStateHistoryDialog">
              <iron-icon slot="item-icon" icon="fa:history" item-icon></iron-icon>
              View Your Search History
            </paper-icon-item>

            <paper-icon-item title="View DIG Database Information" on-tap="openDataInfoDialog">
              <iron-icon slot="item-icon" icon="fa:database" item-icon></iron-icon>
              View DIG Database Information
            </paper-icon-item>

            <template is="dom-if" if="[[serverConfig.tagsListEndpoint]]">
              <paper-icon-item title="View DIG Data Training Options" on-tap="openTagsDialog">
                <iron-icon slot="item-icon" icon="fa:check-circle" item-icon></iron-icon>
                View DIG Data Training Options
              </paper-icon-item>
            </template>

            <paper-icon-item title="Upload a File with Search Terms or Copy & Paste Text" on-tap="openBulkSearchDialog">
              <iron-icon slot="item-icon" icon="fa:upload" item-icon></iron-icon>
              Bulk Search from Uploaded File or Text
            </paper-icon-item>

            <paper-icon-item title="Open a DIG Search Page in a New Tab" on-tap="openNewTab">
              <iron-icon slot="item-icon" icon="fa:external-link-square" item-icon></iron-icon>
              Open a DIG Search Page in a New Tab
            </paper-icon-item>

            <paper-icon-item title="Open DIG Help Page" on-tap="openHelpPage">
              <iron-icon slot="item-icon" icon="fa:question-circle" item-icon></iron-icon>
              Open the DIG Help Page
            </paper-icon-item>

            <paper-icon-item title="Contact DIG / Memex Support (support@memex.software)" on-tap="emailSupport">
              <iron-icon slot="item-icon" icon="fa:envelope" item-icon></iron-icon>
              Contact DIG / Memex Support
            </paper-icon-item>
          </div>
        </iron-dropdown>
      </paper-toolbar>

      <paper-drawer-panel drawer-width="320px" id="pageDrawer">
        <facet-panel slot="drawer" id="pageFacets"
          client="[[esClient]]"
          date-fields="[[dateFieldsToProperties]]"
          facets-query="[[facetsQuery]]"
          image-style-class="[[getBlurStyleClass(blurImages)]]"
          index-name="[[esConfig.esIndex]]"
          index-types="[[esConfig.esType]]"
          network-expansion-parameters="[[networkExpansionParameters]]"
          process-request="{{processRequest}}"
          query-builder-config="[[searchFieldsCollection]]"
          search-endpoint="[[esConfig.searchEndpoint]]"
          search-keys="[[searchKeys]]"
          search-fields="[[searchFields]]"
          search-parameters="{{searchParameters}}">

          <info-facets></info-facets>
        </facet-panel>

        <paper-header-panel slot="main" id="pageSearch">
          <template is="dom-if" if="[[clientConfigLoading]]">
            <loading-spinner slot="header" class="layout horizontal" show type="Configuration"></loading-spinner>
          </template>

          <template is="dom-if" if="[[esConfig]]">
            <paper-material slot="header" id="searchHeader" class="layout horizontal">
              <div class="layout vertical flex">
                <template is="dom-if" if="[[!searchError]]">
                  <div class="layout horizontal">
                    <div class="search-results-title">[[searchTitle]]</div>

                    <template is="dom-if" if="[[searchTotal]]">
                      <info-search search-parameters="[[searchParameters]]"></info-search>
                    </template>
                  </div>
                </template>

                <template is="dom-if" if="[[searchError]]">
                  <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
                  <div class="search-results-title flex">
                    [[searchErrorMessage]]
                  </div>
                </template>
              </div>

              <export-button
                client="[[esClient]]"
                data="[[searchResultsShown]]"
                filter-list="[]"
                index-name="[[esConfig.esIndex]]"
                index-types="[[esConfig.esType]]"
                search-fields="[[searchFields]]"
                search-parameters="[[searchParameters]]"
                source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "@timestamp", "timestamp", "tld", "url"]'
                transform-csv-function="[[transforms.export.createExportDataForCsv]]"
                transform-pdf-function="[[transforms.export.createExportDataForPdf]]"
                transform-search-input-function="[[transforms.export.createBulkSearchData]]"
                transform-search-results-function="[[transforms.entity.results]]">
              </export-button>
            </paper-material>

            <template is="dom-if" if="[[searchResultsShown.length]]">
              <paper-material slot="header" id="searchTimeline" class="layout vertical">
                <template is="dom-if" if="[[sparklineLoading]]">
                  <loading-spinner show type="Timeline"></loading-spinner>
                </template>

                <template is="dom-if" if="[[!sparklineLoading]]">
                  <template is="dom-if" if="[[!sparklineResults.points.length]]">
                    <div class="timeline-text">No Timeline of Search Results</div>
                  </template>

                  <template is="dom-if" if="[[sparklineResults.points.length]]">
                    <div class="timeline-text timeline-header">Timeline of Search Results</div>

                    <sparkline-list time-interval="week" hide-name data="[[sparklineResults.points]]"></sparkline-list>

                    <div class="layout horizontal timeline-text">
                      <template is="dom-if" if="[[sparklineResults.begin]]">
                        <div>[[sparklineResults.begin]]</div>
                      </template>
                      <div class="flex"></div>
                      <template is="dom-if" if="[[sparklineResults.end]]">
                        <div>[[sparklineResults.end]]</div>
                      </template>
                    </div>
                  </template>
                </template>
              </paper-material>

              <paper-material slot="header" id="searchTabs" class="layout horizontal">
                <paper-tabs class="flex" no-bar no-ink selected="{{selectedSearchTab}}">
                  <paper-tab class="flex-1">Webpage Results</paper-tab>
                  <paper-tab class="flex-1">Image Results</paper-tab>
                </paper-tabs>
              </paper-material>
            </template>

            <template is="dom-if" if="[[equals(0, selectedSearchTab)]]">
              <result-list
                id="searchResultList"
                new-tab
                text-property="title"
                query-results="[[searchResults]]"
                total-results="[[searchTotal]]"
                shown-results="{{searchResultsShown}}"
                page="{{searchPage}}"
                page-size="10"
                loading="[[searchLoading]]"
                pretty-name="Webpage Results"
                pretty-name-singular="Webpage Result"
                header="{{searchTitle}}"
                client="[[esClient]]"
                index-name="[[esConfig.esIndex]]"
                index-types="[[esConfig.esType]]"
                id-field="_id"
                search-fields="[[searchFields]]"
                source-include-cached-page='["raw_content"]'
                source-include-nested-data='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "@timestamp", "timestamp", "tld", "url"]'
                transform-cached-page="[[transforms.entity.cache]]"
                transform-nested-data="[[transforms.entity.nestedResults]]"
                small-image-style-class="[[getBlurStyleClass(blurImages)]]"
                large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]"
                tag-manager="[[tagManager]]">
              </result-list>
            </template>

            <template is="dom-if" if="[[equals(1, selectedSearchTab)]]">
              <image-gallery
                id="searchImageGallery"
                images="[[imagesFromResults]]"
                small-image-style-class="[[getBlurStyleClass(blurImages)]]"
                large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]">
              </image-gallery>
            </template>
          </template>
        </paper-header-panel>
      </paper-drawer-panel>
    </paper-header-panel>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      /* globals _, DigBehaviors */
      is: 'search-page',

      behaviors: [
        DigBehaviors.ArrayBehavior
      ],

      properties: {
        blurImages: {
          type: Boolean
        },

        cases: {
          type: Array
        },

        clientConfig: {
          type: Object
        },

        clientConfigError: {
          type: Object
        },

        clientConfigFields: {
          type: Object
        },

        clientConfigLoading: {
          type: Boolean
        },

        configHeader: {
          computed: 'createAuthHeader(serverConfig)',
          type: Object
        },

        dateFieldsToProperties: {
          type: Object
        },

        datePropertiesToKeys: {
          type: Object
        },

        domain: {
          computed: 'findDomain(parameters, serverConfig)',
          notify: true,
          type: String
        },

        emailAddress: {
          type: String
        },

        esClient: {
          type: Object
        },

        esConfig: {
          type: Object
        },

        facetsQuery: {
          type: Object
        },

        hasHistory: {
          type: Boolean
        },

        imagesFromResults: {
          computed: 'findImagesFromResults(searchResultsShown)',
          type: Array
        },

        imagesProcessing: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imagesUploaded: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imageFaceSearchList: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imageFaceSearchLoading: {
          type: Boolean
        },

        imageFaceSearchRunning: {
          type: Boolean,
          value: false
        },

        imageFaceSearchThreshold: {
          type: Number,
          value: 0.1
        },

        imageSimilaritySearchList: {
          type: Array,
          value: function() {
            return [];
          }
        },

        imageSimilaritySearchLoading: {
          type: Boolean
        },

        imageSimilaritySearchRunning: {
          type: Boolean,
          value: false
        },

        imageSimilaritySearchThreshold: {
          type: Number,
          value: 0.3
        },

        logger: {
          type: Object
        },

        logMessage: {
          type: Object
        },

        networkExpansionParameters: {
          type: Object
        },

        notifications: {
          type: Boolean
        },

        notificationInterval: {
          type: String
        },

        parameters: {
          computed: 'findUrlParameters()',
          type: Object
        },

        processRequest: {
          type: Boolean
        },

        profileManager: {
          type: Object
        },

        searchError: {
          type: Object
        },

        searchErrorMessage: {
          type: String
        },

        searchFields: {
          type: Array
        },

        searchFieldsDialogConfig: {
          type: Object
        },

        searchKeys: {
          type: Array
        },

        searchLoading: {
          notify: true,
          type: Boolean
        },

        searchPage: {
          type: Number
        },

        searchParameters: {
          type: Object
        },

        searchQuery: {
          type: Object
        },

        searchQueryTransformerResults: {
          type: Object
        },

        searchResults: {
          observer: 'resetSearchTab',
          type: Array
        },

        searchResultsShown: {
          type: Array
        },

        searchTitle: {
          type: String
        },

        searchTotal: {
          type: Number
        },

        selectedSearchTab: {
          notify: true,
          type: Number,
          value: 0
        },

        serverConfig: {
          type: Object
        },

        stateHistory: {
          type: Array
        },

        tagManager: {
          type: Object
        },

        transforms: {
          type: Object
        },

        userId: {
          type: String
        },

        userLoading: {
          type: Boolean
        }
      },

      observers: [
        'runBothImageSearches(imagesUploaded)'
      ],

      attached: function() {
        var self = this;

        window.onpopstate = function() {
          // TODO: refreshing for now. Need to address issues with interrupting logging entries -- perhaps a better
          // approach would to be not to reload the page, but to rerun the query with the changed parameters + make
          // sure logging is done correctly in this case, which may involve adding processRequest to create-log-message.
          window.location.reload();
        };

        window.onload = function() {
          if(window.history.state && window.history.state.stateHistory) {
            self.set('stateHistory', window.history.state.stateHistory);
          }
        };
      },

      concat: function(a, b) {
        if(a && b) {
          return a + b;
        }
        return undefined;
      },

      createAuthHeader: function(serverConfig) {
        if(serverConfig.configUsername && serverConfig.configPassword) {
          return {
            'Authorization': 'Basic ' + btoa(serverConfig.configUsername + ':' + serverConfig.configPassword)
          };
        }
        return {};
      },

      createResetDatesFunction: function(searchFields) {
        return function(searchParameters, startDateString, endDateString) {
          searchFields.forEach(function(searchFieldsObject) {
            if(searchFieldsObject.isDate) {
              searchParameters[searchFieldsObject.key] = {};
              searchParameters[searchFieldsObject.key][searchFieldsObject.dateProperties.start.key] = startDateString ? {
                key: searchFieldsObject.dateProperties.start.key,
                category: searchFieldsObject.dateProperties.start.title,
                date: new Date(startDateString),
                enabled: true,
                text: startDateString
              } : undefined;
              searchParameters[searchFieldsObject.key][searchFieldsObject.dateProperties.end.key] = endDateString ? {
                key: searchFieldsObject.dateProperties.end.key,
                category: searchFieldsObject.dateProperties.end.title,
                date: new Date(endDateString),
                enabled: true,
                text: endDateString
              } : undefined;
            }
          });
          return searchParameters;
        };
      },

      exists: function(object) {
        return typeof object !== 'undefined';
      },

      findDomain: function(parameters, serverConfig) {
        if(parameters && serverConfig) {
          /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
          var override = serverConfig.overrideConfig ? serverConfig.overrideConfig.project_name : '';
          /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
          return override || parameters.domain || parameters.project || serverConfig.defaultProject;
        }
        return undefined;
      },

      findUrlParameters: function() {
        var parameterInput = window.location.search;
        var parameters = {};
        if(parameterInput && parameterInput !== '?') {
          (parameterInput.indexOf('?') === 0 ? parameterInput.slice(1) : parameterInput).split('&').forEach(function(parameter) {
            var parameterSplit = parameter.split('=');
            parameters[parameterSplit[0]] = (parameterSplit.length > 1 ? parameterSplit[1] : true);
          });
        }
        return parameters;
      },

      getBlurStyleClass: function(blur, large) {
        return (blur ? (large ? 'large-blur' : 'small-blur') : '');
      },

      /************* PAGE *************/
      buildSearchState: function(config, oldConfig) {
        var state = {};
        _.keys(oldConfig).forEach(function(key) {
          state[key] = config[key] || {};
        });
        return state;
      },

      createSearchResultConfig: function(networkExpansionParameters) {
        return {
          isNetworkExpansion: !!(_.findKey(networkExpansionParameters, function(key) {
            return key;
          }))
        };
      },

      createTotalCountFunction: function() {
        return function(response) {
          if(response && response.length && response[0] && response[0].result) {
            if(_.isArray(response[0].result)) {
              return (response[0].result.length && response[0].result[1].hits && response[0].result[1].hits.total ? response[0].result[1].hits.total : 0);
            }
            return (response[0].result.hits && response[0].result.hits.total ? response[0].result.hits.total : 0);
          }
          return 0;
        };
      },

      equals: function(one, two) {
        return one === two;
      },

      findImagesFromResults: function(searchResults) {
        var images = [];
        searchResults.forEach(function(result) {
          (result.images || []).forEach(function(image) {
            images.push(image);
          });
        });
        return images;
      },

      getUrlWithProject: function(domain) {
        return './?project=' + domain;
      },

      handleImageFaceSearchResults: function(event) {
        if(event.detail.error || event.detail.response.error) {
          while(this.imageFaceSearchList.length && this.imageFaceSearchList[0].face) {
            var inputImage = this.imageFaceSearchList.shift();
            this.handleImageResults('Face', inputImage, [], [], [], this.imageFaceSearchThreshold, (event.detail.error || event.detail.response.error));
          }
        }

        /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
        var response = (event.detail.response || {}).AllSimilarFaces || [];
        /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
        if(response && response.length) {
          var self = this;
          response.forEach(function(imageResults) {
            /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
            var imageUrls = imageResults.SimilarFaces.CachedImageURLs;
            var imageIds = imageResults.SimilarFaces.ImageSha1s;
            var imageDistances = imageResults.SimilarFaces.Distances;
            /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

            var inputImage = self.imageFaceSearchList.shift();
            self.handleImageResults('Face', inputImage, imageUrls, imageIds, imageDistances, self.imageFaceSearchThreshold);
          });
        }

        this.runImageFaceSearch();
      },

      handleImageSimilaritySearchResults: function(event) {
        if(event.detail.error || event.detail.response.error) {
          while(this.imageSimilaritySearchList.length && this.imageSimilaritySearchList[0].similarity) {
            var inputImage = this.imageSimilaritySearchList.shift();
            this.handleImageResults('Similarity', inputImage, [], [], [], this.imageSimilaritySearchThreshold, (event.detail.error || event.detail.response.error));
          }
        }

        var response = (event.detail.response || {}).images || [];
        if(response && response.length) {
          var self = this;
          response.forEach(function(imageResults) {
            /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
            var imageUrls = imageResults.similar_images.cached_image_urls;
            var imageIds = imageResults.similar_images.sha1;
            var imageDistances = imageResults.similar_images.distance;
            /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */

            var inputImage = self.imageSimilaritySearchList.shift();
            self.handleImageResults('Similarity', inputImage, imageUrls, imageIds, imageDistances, self.imageSimilaritySearchThreshold);
          });
        }

        this.runImageSimilaritySearch();
      },

      handleImageResults: function(searchType, inputImage, imageUrls, imageIds, imageDistances, imageThreshold, error) {
        var imageIndex = _.findIndex(this.imagesUploaded, function(object) {
          return object.id === inputImage.id;
        });

        if(imageIndex < 0) {
          return;
        }

        var linkFunction = this.transforms && this.transforms.entity ? this.transforms.entity.externalImageLink : null;

        // Remove images with distances over the threshold.
        var sliceIndex = _.findIndex(imageDistances, function(distance) {
          return _.toNumber(distance) > imageThreshold;
        });

        var previousImageResults = this.imagesUploaded[imageIndex].hits || [];
        var imageResults = imageIds.map(function(id, index) {
          return {
            id: id,
            link: (linkFunction ? linkFunction(id) : ''),
            rank: imageDistances[index],
            source: imageUrls[index]
          };
        }).slice(0, sliceIndex < 0 ? imageIds.length : sliceIndex);

        // Mark one search as done.
        this.imagesUploaded[imageIndex].searches = this.imagesUploaded[imageIndex].searches - 1;
        if(!this.imagesUploaded[imageIndex].searches) {
          this.set('imagesProcessing', this.imagesProcessing.map(function(id) {
            return id;
          }).filter(function(id) {
            return id !== inputImage.id;
          }));
        }

        var allResults = !previousImageResults.length ? imageResults : _.uniqBy(previousImageResults.concat(imageResults).sort(function(a, b) {
          return a.rank - b.rank;
        }), 'id').map(function(result, index) {
          result.name = 'Match #' + (index + 1) + ' (' + inputImage.id + ')';
          return result;
        });

        this.set(['imagesUploaded', imageIndex, 'hits'], allResults);

        if(error && this.logger) {
          this.logger.log('ImageSearch' + searchType + '-Error', '{"type":"' + inputImage.type + '","name":"' + inputImage.id + '"}');
        }
      },

      runBothImageSearches: function() {
        if(!this.imagesUploaded.length) {
          return;
        }

        // Find all of the new images using their names as unique identifiers.
        var self = this;
        var images = this.imagesUploaded.filter(function(object) {
          var search = _.isUndefined(object.hits);
          object.hits = null;
          return search;
        });

        self.set('imagesProcessing', this.imagesProcessing.concat(images.map(function(object) {
          return object.id;
        })));

        this.set('imageFaceSearchList', this.imageFaceSearchList.concat(images));

        // Use the map function to create a new array.
        this.set('imageSimilaritySearchList', this.imageSimilaritySearchList.concat(images.map(function(object) {
          return object;
        })));

        // Run the face and similarity searches simultaneously.
        if(!this.imageFaceSearchRunning) {
          this.runImageFaceSearch();
        }
        if(!this.imageSimilaritySearchRunning) {
          this.runImageSimilaritySearch();
        }
      },

      runImageFaceSearch: function() {
        if(!this.imageFaceSearchList.length) {
          this.imageFaceSearchRunning = false;
          return;
        }

        this.imageFaceSearchRunning = true;
        this.sendImageSearchRequest('Face', 'imageFaceSearch', this.imageFaceSearchList, this.imageFaceSearchThreshold);
      },

      runImageSimilaritySearch: function() {
        if(!this.imageSimilaritySearchList.length) {
          this.imageSimilaritySearchRunning = false;
          return;
        }

        this.imageSimilaritySearchRunning = true;
        this.sendImageSearchRequest('Similarity', 'imageSimilaritySearch', this.imageSimilaritySearchList, this.imageSimilaritySearchThreshold);
      },

      sendImageSearchRequest: function(searchType, searchName, searchList, imageThreshold) {
        // Run in batches of 5.  All 5 must be either links or uploaded files.
        var dataType = searchList[0].type;
        var objectList = searchList.filter(function(object) {
          return object.type === dataType;
        }).slice(0, 5);
        var sourceList = searchList.map(function(object) {
          // Set the 'face' or 'similarity' property to 'true' for the objects in the search.
          object[searchType.toLowerCase()] = true;
          if(dataType === 'DATA') {
            return object.source.substring(object.source.indexOf(';base64,') + 8);
          }
          return object.source;
        });

        var authConfig = (this.serverConfig.imageServiceConfig.auth || {});
        var auth = authConfig.user && authConfig.password ? 'Basic ' + btoa(authConfig.user + ':' + authConfig.password) : '';
        var endpointConfig = (this.serverConfig.imageServiceConfig.endpoint || {});
        var endpoint = endpointConfig[dataType.toLowerCase()];
        var hostConfig = (this.serverConfig.imageServiceConfig.host || {});
        var host = hostConfig[searchType.toLowerCase()];

        if(this.logger) {
          var logMessage = '["' + objectList.map(function(object) {
            return object.id;
          }).join('","') + '"]';
          this.logger.log('ImageSearch' + searchType + '-Start', logMessage);
        }

        if(auth && endpoint && host) {
          var requestElement = this.$$('#' + searchName);
          requestElement.body = {
            data: sourceList.join(',')
          };
          requestElement.body.options = '{"max_returned":1000,"near_dup":1,"near_dup_th":' + imageThreshold + '}';
          requestElement.url = host + endpoint;
          requestElement.headers = requestElement.headers || {};
          requestElement.headers.Authorization = auth;
          requestElement.generateRequest();
        }
      },

      validateImageServiceConfig: function(config) {
        return config && config.auth && config.auth.user && config.auth.password && config.endpoint && config.endpoint.data && config.endpoint.link && config.host && config.host.face && config.host.similarity;
      },
      /********************************/

      /************* MENU *************/
      emailSupport: function() {
        window.open('mailto:support@memex.software');
      },

      /**
       * Returns whether all the terms in the given search parameters object are disabled.
       *
       * @param {Object} searchParameters
       * @return {Boolean}
       */
      searchParametersDisabled: function(searchParameters) {
        return _.keys(searchParameters).every(function(type) {
          return _.keys(searchParameters[type]).every(function(term) {
            return !searchParameters[type][term].enabled;
          });
        });
      },

      openBulkSearchDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#bulkSearchDialog').open();
      },

      openDataInfoDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#dataInfoDialog').open();
      },

      openHelpPage: function() {
        this.$$('#menuDropdown').close();
        window.open('./help.html');
      },

      openNewTab: function() {
        window.open('./?project=' + this.domain);
      },

      openSaveDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#saveDialog').open();
      },

      openStateHistoryDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#stateManager').openStateHistory();
      },

      openTagsDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#tagManager').openDialog();
      },

      resetSearchTab: function() {
        if(!this.searchResults.length) {
          this.set('selectedSearchTab',0);
        }
      },

      toggleMenu: function() {
        if(this.$$('#menuDropdown').style.display === 'none') {
          this.$$('#menuDropdown').open();
        } else {
          this.$$('#menuDropdown').close();
        }
      }
      /********************************/
    });
  })();
  </script>
</dom-module>
