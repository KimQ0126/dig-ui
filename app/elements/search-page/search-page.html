<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/array-behavior/array-behavior.html">
<link rel="import" href="../../bower_components/dig-logger/dig-logger.html">
<link rel="import" href="../../bower_components/elastic-client/elastic-client.html">
<link rel="import" href="../../bower_components/elastic-error/elastic-error.html">
<link rel="import" href="../../bower_components/export-button/export-button.html">
<link rel="import" href="../../bower_components/facet-panel/facet-panel.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/json-combine/json-combine.html">
<link rel="import" href="../../bower_components/loading-spinner/loading-spinner.html">
<link rel="import" href="../../bower_components/lodash-import/lodash.html">
<link rel="import" href="../../bower_components/log-creator/log-creator.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/profile-manager/profile-manager.html">
<link rel="import" href="../../bower_components/query-builder/query-builder.html">
<link rel="import" href="../../bower_components/query-transformer/query-transformer.html">
<link rel="import" href="../../bower_components/result-list/result-list.html">
<link rel="import" href="../../bower_components/search-fields-dialog/search-fields-dialog.html">
<link rel="import" href="../../bower_components/state-manager/state-manager.html">
<link rel="import" href="../../bower_components/tag-manager/tag-manager.html">
<link rel="import" href="../../bower_components/user-settings-dialog/user-settings-dialog.html">
<link rel="import" href="../../elements/info-data/info-data.html">
<link rel="import" href="../../elements/info-facets/info-facets.html">
<link rel="import" href="../../elements/info-search/info-search.html">
<link rel="import" href="../../elements/similar-image-search/similar-image-search.html">
<link rel="import" href="../../elements/transform-functions/transform-functions.html">
<link rel="import" href="../../styles/page-styles.html">

<dom-module id="search-page">
  <template>
    <style include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning"></style>
    <style include="page-styles"></style>

    <style>
      :host {
        display: block;
        @apply --layout-fullbleed;
      }

      search-fields-dialog {
        /* Center with the screen.  Left:  320px facets drawer.  Right:  10px navbar padding + 40px per navbar icon. */
        margin-right: 230px;
      }

      paper-drawer-panel {
        --paper-drawer-panel-left-drawer-container: {
          background-color: var(--primary-background-color);
          border-right: 1px solid rgba(0,0,0,var(--dark-divider-opacity));
        };
      }

      paper-toolbar {
        background-color: var(--navbar-color);
        color: var(--text-primary-color);
        --paper-toolbar-height: 60px;
        --paper-toolbar-content: {
          padding: 0 10px;
        };
      }

      paper-toolbar modal-icon {
        --paper-icon-button: {
          margin: 20px 0 0;
        };
      }

      paper-toolbar paper-icon-button {
        --paper-icon-button: {
          padding: 5px;
        };
      }

      /* Spacer to match drawer width */
      paper-toolbar .drawer-spacer {
        width: 220px;
      }

      facet-panel {
        --facet-panel-selected-facet-background-color: var(--facet-background-color);
        --facet-panel-selected-facet-text-color: var(--primary-text-color);
        --facet-panel-selected-facet-icon-hover-color: #fff;
      }

      #searchPanel {
        --paper-header-panel-container: {
          background-color: #ffffff;
        };
      }

      #searchTitle {
        @apply --shadow-elevation-2dp;
        padding: 20px 30px;
      }

      #searchTitle .search-results-title {
        font-size: 24px;
        font-weight: 500;
        /* Match the height of the export button. */
        line-height: 30px;
        /* Needed to fix flexbox layout issues in newer browsers. */
        display: -webkit-box;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        word-break: break-word;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
      }

      #searchTitle sparkline-list {
        height: 25px;
        margin-top: 15px;
      }

      #searchResults {
        position: absolute;
        top: 150px;
        bottom: 0;
        left: 0;
        right: 0;

        --result-list-scroll-threshold: {
          @apply --shadow-elevation-2dp;
          height: auto;
          max-height: none;
          position: absolute;
          bottom: 70px;
          top: 0;
          left: 0;
          right: 0;
        };

        --result-list-loading-spinner: {
          position: absolute;
          bottom: 20px;
          left: 0;
          right: 0;
          padding: 25px 0 5px;
        };

        --result-list-show-more-button: {
          position: absolute;
          bottom: 20px;
          left: 0;
          right: 0;
          padding: 20px 0 0;
        };
      }

      #searchGallery {
        position: absolute;
        top: 150px;
        bottom: 0px;
        left: 0;
        right: 0;
        overflow-y: scroll;
      }

      #searchTab {
        @apply --shadow-elevation-2dp;
        position: absolute;
        top: 110px;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
      }

      #searchTab paper-tab {
        color: var(--secondary-text-color);
        font-size: 16px;
        font-weight: 500;
        padding: 0 15px;
      }

      #searchTab paper-tab:hover {
        background-color: rgba(0,0,0,0.05);
        color: var(--primary-text-color);
      }

      #searchTab paper-tab.iron-selected {
        background-color: rgba(0,0,0,0.1);
        color: var(--primary-text-color);
      }
    </style>

    <iron-ajax
      auto
      handle-as="json"
      url="/serverConfig"
      last-response="{{serverConfig}}">
    </iron-ajax>

    <template is="dom-if" if="[[serverConfig.overrideConfig]]">
      <transform-functions
        client-config="[[serverConfig.overrideConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[serverConfig.overrideConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <template is="dom-if" if="[[!serverConfig.overrideConfig]]">
      <iron-ajax
        auto="[[exists(configHeader)]]"
        handle-as="json"
        headers="[[configHeader]]"
        url="[[concat(serverConfig.configEndpoint, domain)]]"
        with-credentials
        loading="{{clientConfigLoading}}"
        last-error="{{clientConfigError}}"
        last-response="{{clientConfig}}">
      </iron-ajax>

      <transform-functions
        client-config="[[clientConfig]]"
        domain="[[domain]]"
        server-config="[[serverConfig]]"
        es-config="{{esConfig}}"
        transforms="{{transforms}}">
      </transform-functions>

      <json-combine
        data-in1="[[clientConfig]]"
        data-in2="{}"
        data-out="{{clientConfigFields}}"
        combine-function="[[transforms.config.fields]]">
      </json-combine>
    </template>

    <json-combine
      data-in1="[[clientConfigFields]]"
      data-in2="{}"
      data-out="{{searchFields}}"
      combine-function="[[transforms.config.searchFields]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{dateFieldsToProperties}}"
      combine-function="[[transforms.config.dateFieldsToProperties]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{datePropertiesToKeys}}"
      combine-function="[[transforms.config.datePropertiesToKeys]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsDialogConfig}}"
      combine-function="[[transforms.config.searchFieldsDialogConfig]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchFieldsCollection}}"
      combine-function="[[transforms.config.searchFieldsCollection]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchKeys}}"
      combine-function="[[transforms.config.searchKeys]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{searchParameters}}"
      combine-function="[[transforms.config.searchParameters]]">
    </json-combine>

    <json-combine
      data-in1="[[searchFields]]"
      data-in2="{}"
      data-out="{{networkExpansionParameters}}"
      combine-function="[[transforms.config.networkExpansionParameters]]">
    </json-combine>

    <json-combine
      data-in1="[[datePropertiesToKeys]]"
      data-in2="{}"
      data-out="{{searchQuery}}"
      combine-function="[[transforms.search.createSearchQuery]]">
    </json-combine>

    <json-combine
      data-in1="[[datePropertiesToKeys]]"
      data-in2="{}"
      data-out="{{facetsQuery}}"
      combine-function="[[transforms.search.createFacetsQuery]]">
    </json-combine>

    <query-transformer
      error="{{searchError}}"
      loading="{{searchLoading}}"
      page="{{searchPage}}"
      page-size="25"
      process-request="[[processRequest]]"
      result-config="[[createSearchResultConfig(networkExpansionParameters, networkExpansionParameters.*)]]"
      result-function="[[transforms.search.searchResults]]"
      results="{{searchResults}}"
      search-parameters="[[searchParameters]]"
      search-config="[[networkExpansionParameters]]"
      search-function="[[searchQuery]]"
      total-count-function="[[createTotalCountFunction()]]"
      total="{{searchTotal}}"
      url="[[esConfig.searchEndpoint]]">
    </query-transformer>

    <json-combine
      data-in1="[[searchResults]]"
      data-in2="[[searchFields]]"
      data-out="{{documents}}"
      combine-function="[[transforms.entity.documents]]">
    </json-combine>

    <elastic-client
      config="[[serverConfig.esHost]]"
      client="{{esClient}}">
    </elastic-client>

    <!-- Logger for Search Terms -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndex]]"
      es-type="[[serverConfig.logType]]"
      type="Search-SubmitSearch"
      data="[[logMessage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Pagination -->
    <dig-logger
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndex]]"
      es-type="[[serverConfig.logType]]"
      type="Search-ResultPage"
      data="[[searchPage]]"
      username="[[serverConfig.username]]">
    </dig-logger>

    <!-- Logger for Page View -->
    <dig-logger log-page-view
      es-client="[[esClient]]"
      es-index="[[serverConfig.logIndex]]"
      es-type="[[serverConfig.logType]]"
      type="Search-Open"
      username="[[serverConfig.username]]"
      logger="{{logger}}">
    </dig-logger>

    <log-creator
      object="{{searchParameters}}"
      log-message="{{logMessage}}">
    </log-creator>

    <profile-manager
      build-search-state-function="[[transforms.config.searchState]]"
      client="[[esClient]]"
      index-name="[[serverConfig.profileIndexName]]"
      index-type="[[serverConfig.profileIndexType]]"
      query-builder-config="[[searchFieldsCollection]]"
      query-builder-date-fields="[[dateFieldsToProperties]]"
      search-parameters="[[searchParameters]]"
      username="[[serverConfig.username]]"
      blur-images="{{blurImages}}"
      cases="{{cases}}"
      email-address="{{emailAddress}}"
      notifications="{{notifications}}"
      notification-interval="{{notificationInterval}}"
      profile-manager="{{profileManager}}"
      user-id="{{userId}}"
      user-loading="{{userLoading}}">
    </profile-manager>

    <tag-manager
      id="tagManager"
      auth-username="[[serverConfig.configUsername]]"
      auth-password="[[serverConfig.configPassword]]"
      entity-endpoint="[[serverConfig.tagsEntityEndpoint]]"
      extraction-endpoint="[[serverConfig.tagsExtractionEndpoint]]"
      list-endpoint="[[serverConfig.tagsListEndpoint]]"
      project="[[domain]]"
      tag-manager="{{tagManager}}">
    </tag-manager>

    <!-- Must wait for the searchParameters to be defined. -->
    <template is="dom-if" if="[[searchParameters]]">
      <state-manager id="stateManager"
        build-popup-data-function="[[transforms.config.searchTerms]]"
        build-state-data-function="[[transforms.config.searchState]]"
        client="[[esClient]]"
        function-config="[[searchFields]]"
        state-index="[[serverConfig.stateIndexName]]"
        state-type="[[serverConfig.stateIndexType]]"
        state-id="[[parameters.state]]"
        collection="{{searchParameters}}"
        process-request="{{processRequest}}"
        state-history="{{stateHistory}}"
        has-history="{{hasHistory}}">
      </state-manager>
    </template>

    <info-data
      id="dataInfoDialog"
      client="[[esClient]]"
      index-name="[[esConfig.esIndex]]"
      index-types="[[esConfig.esType]]"
      domain="[[domain]]"
      sort-field="timestamp_crawl">
    </info-data>

    <bulk-search
      id="bulkSearchDialog"
      search-fields="[[searchFields]]"
      parameter-key="[[searchFields.0.key]]"
      search-parameters="{{searchParameters}}"
      process-request="{{processRequest}}"
      build-search-state="[[buildSearchState]]">
    </bulk-search>

    <query-builder
      config="[[searchFieldsCollection]]"
      data="[[searchParameters]]"
      date-fields="[[dateFieldsToProperties]]"
      query="{{esQuery}}">
    </query-builder>

    <elastic-client-aggregation-builder
      name="timestamp_crawl"
      type="date_histogram"
      count="0"
      field="timestamp_crawl"
      interval="day"
      ejs-aggregation="{{dateAggregation}}">
    </elastic-client-aggregation-builder>

    <template is="dom-if" if="[[dateAggregation]]">
      <build-and-run-query
        query="[[esQuery]]"
        client="[[esClient]]"
        index-name="[[esConfig.esIndex]]"
        index-types="[[esConfig.esType]]"
        aggregations="[[buildArray(dateAggregation)]]"
        filters="[]"
        page-size="0"
        source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "timestamp_crawl", "tld", "url"]'
        source-exclude='["knowledge_graph.*.provenance"]'
        transform-config='{"date":{"key":"timestamp_crawl"}}'
        transform-function="[[transforms.entity.histograms]]"
        error="{{sparklineError}}"
        loading="{{sparklineLoading}}"
        results="{{sparklineResults}}">
      </build-and-run-query>
    </template>

    <paper-header-panel class="flex" mode="waterfall">
      <paper-toolbar slot="header">
        <img slot="top" src="images/dig-logo.png" alt="">
        <div slot="top" class="drawer-spacer"></div>

        <div slot="top" class="flex">
          <search-fields-dialog
            date-config="[[datePropertiesToKeys]]"
            search-fields-config="[[searchFieldsDialogConfig]]"
            search-parameters="{{searchParameters}}"
            network-expansion-parameters="{{networkExpansionParameters}}"
            process-request="{{processRequest}}">
          </search-fields-dialog>
        </div>

        <a slot="top" href="[[getUrlWithProject(domain)]]" style="color: #ffffff;">
          <paper-icon-button icon="fa:times" title="Reset Page"></paper-icon-button>
        </a>

        <similar-image-search id="similarImageSearchDialog"
          logger="[[logger]]"
          blur="[[blurImages]]"
          image-service-auth="[[serverConfig.imageServiceAuth]]"
          image-service-host="[[serverConfig.imageServiceHost]]"
          link-function="[[transforms.entity.externalImageLink]]">
        </similar-image-search>
        <!-- TODO: add logger, update transform when we're ready to link to image entity pages -->

        <user-settings-dialog
          slot="top"
          show-search
          build-search-state-function="[[transforms.config.searchState]]"
          build-search-terms-function="[[transforms.config.searchTerms]]"
          reset-search-dates-function="[[createResetDatesFunction(searchFields)]]"
          cases="[[cases]]"
          user-id="[[userId]]"
          user-loading="[[userLoading]]"
          username="[[serverConfig.username]]"
          blur-images="{{blurImages}}"
          email-address="{{emailAddress}}"
          notifications="{{notifications}}"
          notification-date="{{notificationDate}}"
          notification-interval="{{notificationInterval}}"
          search-parameters="{{searchParameters}}">
        </user-settings-dialog>

        <paper-icon-button icon="fa:bars" slot="top" slot="dropdown-trigger" title="More Options" on-tap="toggleMenu"></paper-icon-button>

        <iron-dropdown id="menuDropdown" slot="top" horizontal-align="right" vertical-align="top" vertical-offset="60">
          <div slot="dropdown-content">
            <paper-icon-item title="View DIG Database Information" on-tap="openDataInfoDialog">
              <iron-icon slot="item-icon" icon="fa:database" item-icon></iron-icon>
              View DIG Database Information
            </paper-icon-item>

            <paper-icon-item disabled="[[!hasHistory]]" title="View Your Search History" on-tap="openStateHistoryDialog">
              <iron-icon slot="item-icon" icon="fa:history" item-icon></iron-icon>
              View Your Search History
            </paper-icon-item>

            <paper-icon-item title="View DIG Data Training Options" on-tap="openTagsDialog">
              <iron-icon slot="item-icon" icon="fa:check-circle" item-icon></iron-icon>
              View DIG Data Training Options
            </paper-icon-item>

            <paper-icon-item title="Upload a File with Search Terms or Copy & Paste Text" on-tap="openBulkSearchDialog">
              <iron-icon slot="item-icon" icon="fa:upload" item-icon></iron-icon>
              Bulk Search from Uploaded File or Text
            </paper-icon-item>

            <paper-icon-item title="Search on an Image URL or Uploaded Image" on-tap="openSimilarImageSearchDialog">
              <iron-icon slot="item-icon" icon="fa:picture-o" item-icon></iron-icon>
              Similar Image Search
            </paper-icon-item>

            <paper-icon-item title="Open a DIG Search Page in a New Tab" on-tap="openNewTab">
              <iron-icon slot="item-icon" icon="fa:external-link-square" item-icon></iron-icon>
              Open a DIG Search Page in a New Tab
            </paper-icon-item>

            <paper-icon-item title="Open DIG Help Page" on-tap="openHelpPage">
              <iron-icon slot="item-icon" icon="fa:question-circle" item-icon></iron-icon>
              Open the DIG Help Page
            </paper-icon-item>

            <paper-icon-item title="Contact DIG / Memex Support (support@memex.software)" on-tap="emailSupport">
              <iron-icon slot="item-icon" icon="fa:envelope" item-icon></iron-icon>
              Contact DIG / Memex Support
            </paper-icon-item>
          </div>
        </iron-dropdown>
      </paper-toolbar>

      <paper-drawer-panel drawer-width="320px">
        <facet-panel slot="drawer"
          date-fields="[[dateFieldsToProperties]]"
          facets-query="[[facetsQuery]]"
          network-expansion-parameters="[[networkExpansionParameters]]"
          process-request="{{processRequest}}"
          search-endpoint="[[esConfig.searchEndpoint]]"
          search-keys="[[searchKeys]]"
          search-fields="[[searchFields]]"
          search-parameters="{{searchParameters}}">

          <info-facets></info-facets>
        </facet-panel>

        <paper-header-panel slot="main" id="searchPanel">
          <template is="dom-if" if="[[clientConfigLoading]]">
            <loading-spinner class="layout horizontal" style="margin: 10px 20px;" show type="Configuration"></loading-spinner>
          </template>

          <template is="dom-if" if="[[esConfig]]">
            <div id="searchTitle" class="layout vertical">
              <div class="layout horizontal">
                <div class="layout vertical flex">
                  <template is="dom-if" if="[[!searchError]]">
                    <div class="layout horizontal">
                      <div class="search-results-title">[[searchTitle]]</div>

                      <template is="dom-if" if="[[searchTotal]]">
                        <info-search search-parameters="[[searchParameters]]"></info-search>
                      </template>
                    </div>
                  </template>

                  <template is="dom-if" if="[[searchError]]">
                    <elastic-error error="[[searchError]]" message="{{searchErrorMessage}}"></elastic-error>
                    <div class="search-results-title flex">
                      [[searchErrorMessage]]
                    </div>
                  </template>
                </div>

                <export-button
                  client="[[esClient]]"
                  data="[[documentsInList]]"
                  filter-list="[]"
                  index-name="[[esConfig.esIndex]]"
                  index-types="[[esConfig.esType]]"
                  search-fields="[[searchFields]]"
                  search-parameters="[[searchParameters]]"
                  source-include='["content_extraction.content_strict.text", "content_extraction.title.text", "doc_id", "knowledge_graph", "objects", "timestamp_crawl", "tld", "url"]'
                  transform-csv-function="[[transforms.export.createExportDataForCsv]]"
                  transform-pdf-function="[[transforms.export.createExportDataForPdf]]"
                  transform-search-input-function="[[transforms.export.createBulkSearchData]]"
                  transform-search-results-function="[[transforms.entity.documents]]">
                </export-button>
              </div>

              <sparkline-list time-interval="day" hide-name data="[[sparklineResults.items]]"></sparkline-list>
            </div>

            <template is="dom-if" if="[[documentsInList.length]]">
              <paper-material>
                <paper-tabs id="searchTab" class="flex" no-bar no-ink selected="{{selectedSearchTab}}">
                  <paper-tab class="flex-1">Document Results</paper-tab>
                  <paper-tab class="flex-1">Image Results</paper-tab>
                </paper-tabs>
              </paper-material>
            </template>

            <template is="dom-if" if="[[equals(0, selectedSearchTab)]]">
              <result-list
                id="searchResults"
                new-tab
                text-property="title"
                query-results="[[documents]]"
                total-results="[[searchTotal]]"
                shown-results="{{documentsInList}}"
                page="{{searchPage}}"
                page-size="25"
                loading="[[searchLoading]]"
                header="{{searchTitle}}"
                cache-transform="[[transforms.entity.cache]]"
                client="[[esClient]]"
                index-name="[[esConfig.esIndex]]"
                index-types="[[esConfig.esType]]"
                search-fields="[[searchFields]]"
                source-include='["raw_content"]'
                small-image-style-class="[[getBlurStyleClass(blurImages)]]"
                large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]"
                tag-manager="[[tagManager]]">
              </result-list>
            </template>

            <template is="dom-if" if="[[equals(1, selectedSearchTab)]]">
              <image-gallery
                id="searchGallery"
                images="[[imagesFromDocuments]]"
                small-image-style-class="[[getBlurStyleClass(blurImages)]]"
                large-image-style-class="[[getBlurStyleClass(blurImages, 'large')]]">
              </image-gallery>
            </template>
          </template>
        </paper-header-panel>
      </paper-drawer-panel>
    </paper-header-panel>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      /* globals _, DigBehaviors */
      is: 'search-page',

      behaviors: [
        DigBehaviors.ArrayBehavior
      ],

      properties: {
        blurImages: {
          type: Boolean
        },

        cases: {
          type: Array
        },

        clientConfig: {
          type: Object
        },

        clientConfigError: {
          type: Object
        },

        clientConfigFields: {
          type: Object
        },

        clientConfigLoading: {
          type: Boolean
        },

        configHeader: {
          computed: 'createAuthHeader(serverConfig)',
          type: Object
        },

        dateFieldsToProperties: {
          type: Object
        },

        datePropertiesToKeys: {
          type: Object
        },

        documents: {
          observer: 'resetSearchTab',
          type: Array
        },

        documentsInList: {
          type: Array
        },

        domain: {
          computed: 'findDomain(parameters, serverConfig)',
          type: String
        },

        emailAddress: {
          type: String
        },

        esClient: {
          type: Object
        },

        esConfig: {
          type: Object
        },

        facetsQuery: {
          type: Object
        },

        hasHistory: {
          type: Boolean
        },

        imagesFromDocuments: {
          computed: 'findImagesFromDocuments(documentsInList)',
          type: Array
        },

        logger: {
          type: Object
        },

        logMessage: {
          type: Object
        },

        networkExpansionParameters: {
          type: Object
        },

        notifications: {
          type: Boolean
        },

        notificationInterval: {
          type: String
        },

        parameters: {
          computed: 'findUrlParameters()',
          type: Object
        },

        processRequest: {
          type: Boolean
        },

        profileManager: {
          type: Object
        },

        searchError: {
          type: Object
        },

        searchErrorMessage: {
          type: String
        },

        searchFields: {
          type: Array
        },

        searchFieldsDialogConfig: {
          type: Object
        },

        searchKeys: {
          type: Array
        },

        searchLoading: {
          notify: true,
          type: Boolean
        },

        searchPage: {
          type: Number
        },

        searchParameters: {
          type: Object
        },

        searchQuery: {
          type: Object
        },

        searchResults: {
          type: Object
        },

        searchTitle: {
          type: String
        },

        searchTotal: {
          type: Number
        },

        selectedSearchTab: {
          notify: true,
          type: Number,
          value: 0
        },

        serverConfig: {
          type: Object
        },

        stateHistory: {
          type: Array
        },

        tagManager: {
          type: Object
        },

        transforms: {
          type: Object
        },

        userId: {
          type: String
        },

        userLoading: {
          type: Boolean
        }
      },

      attached: function() {
        var self = this;

        window.onpopstate = function() {
          // TODO: refreshing for now. Need to address issues with interrupting logging entries -- perhaps a better
          // approach would to be not to reload the page, but to rerun the query with the changed parameters + make
          // sure logging is done correctly in this case, which may involve adding processRequest to create-log-message.
          window.location.reload();
        };

        window.onload = function() {
          if(window.history.state && window.history.state.stateHistory) {
            self.set('stateHistory', window.history.state.stateHistory);
          }
        };
      },

      concat: function(a, b) {
        if(a && b) {
          return a + b;
        }
        return undefined;
      },

      createAuthHeader: function(serverConfig) {
        if(serverConfig.configUsername && serverConfig.configPassword) {
          return {
            'Authorization': 'Basic ' + btoa(serverConfig.configUsername + ':' + serverConfig.configPassword)
          };
        }
        return {};
      },

      createResetDatesFunction: function(searchFields) {
        return function(searchParameters, startDateString, endDateString) {
          searchFields.forEach(function(searchFieldsObject) {
            if(searchFieldsObject.isDate) {
              searchParameters[searchFieldsObject.key] = {};
              searchParameters[searchFieldsObject.key][searchFieldsObject.dateProperties.start.key] = startDateString ? {
                key: searchFieldsObject.dateProperties.start.key,
                category: searchFieldsObject.dateProperties.start.title,
                date: new Date(startDateString),
                enabled: true,
                text: startDateString
              } : undefined;
              searchParameters[searchFieldsObject.key][searchFieldsObject.dateProperties.end.key] = endDateString ? {
                key: searchFieldsObject.dateProperties.end.key,
                category: searchFieldsObject.dateProperties.end.title,
                date: new Date(endDateString),
                enabled: true,
                text: endDateString
              } : undefined;
            }
          });
          return searchParameters;
        };
      },

      exists: function(object) {
        return typeof object !== 'undefined';
      },

      findDomain: function(parameters, serverConfig) {
        if(parameters && serverConfig) {
          /* jscs:disable requireCamelCaseOrUpperCaseIdentifiers */
          var override = serverConfig.overrideConfig ? serverConfig.overrideConfig.project_name : '';
          /* jscs:enable requireCamelCaseOrUpperCaseIdentifiers */
          return override || parameters.domain || parameters.project || serverConfig.defaultProject;
        }
        return undefined;
      },

      findUrlParameters: function() {
        var parameterInput = window.location.search;
        var parameters = {};
        if(parameterInput && parameterInput !== '?') {
          (parameterInput.indexOf('?') === 0 ? parameterInput.slice(1) : parameterInput).split('&').forEach(function(parameter) {
            var parameterSplit = parameter.split('=');
            parameters[parameterSplit[0]] = (parameterSplit.length > 1 ? parameterSplit[1] : true);
          });
        }
        return parameters;
      },

      getBlurStyleClass: function(blur, large) {
        return (blur ? (large ? 'large-blur' : 'small-blur') : '');
      },

      /************* PAGE *************/
      buildSearchState: function(config, oldConfig) {
        var state = {};
        _.keys(oldConfig).forEach(function(key) {
          state[key] = config[key] || {};
        });
        return state;
      },

      createSearchResultConfig: function(networkExpansionParameters) {
        return {
          isNetworkExpansion: !!(_.findKey(networkExpansionParameters, function(key) {
            return key;
          }))
        };
      },

      createTotalCountFunction: function() {
        return function(response) {
          if(response && response.length && response[0] && response[0].result) {
            if(_.isArray(response[0].result)) {
              return (response[0].result.length && response[0].result[1].hits && response[0].result[1].hits.total ? response[0].result[1].hits.total : 0);
            }
            return (response[0].result.hits && response[0].result.hits.total ? response[0].result.hits.total : 0);
          }
          return 0;
        };
      },

      equals: function(one, two) {
        return one === two;
      },

      findImagesFromDocuments: function(documents) {
        var images = [];
        documents.forEach(function(document) {
          document.images.forEach(function(image) {
            images.push(image);
          });
        });
        return images;
      },

      getUrlWithProject: function(domain) {
        return './?project=' + domain;
      },
      /********************************/

      /************* MENU *************/
      emailSupport: function() {
        window.open('mailto:support@memex.software');
      },

      openBulkSearchDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#bulkSearchDialog').open();
      },

      openDataInfoDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#dataInfoDialog').open();
      },

      openHelpPage: function() {
        this.$$('#menuDropdown').close();
        window.open('./help.html');
      },

      openNewTab: function() {
        window.open('./?project=' + this.domain);
      },

      openSimilarImageSearchDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#similarImageSearchDialog').open();
      },

      openStateHistoryDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#stateManager').openStateHistory();
      },

      openTagsDialog: function() {
        this.$$('#menuDropdown').close();
        this.$$('#tagManager').openDialog();
      },

      resetSearchTab: function() {
        if(!this.documents.length) {
          this.set('selectedSearchTab',0);
        }
      },

      toggleMenu: function() {
        if(this.$$('#menuDropdown').style.display === 'none') {
          this.$$('#menuDropdown').open();
        } else {
          this.$$('#menuDropdown').close();
        }
      }
      /********************************/
    });
  })();
  </script>
</dom-module>
